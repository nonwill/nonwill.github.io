<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>关于 GoldenDict 查询性能提升的一点思考</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="GoldenDict Professional,专业版,箐典,C++11,recursive_mutex,mutex,performance,C++,C,mac"><meta name=description content="箐典,关于GoldenDict++专业版查询性能提升的一点思考,std::recursive_mutex 和 std::mutex 性能差异"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"🌜"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>关于 GoldenDict 查询性能提升的一点思考</span><span class=btRight><span title="Translator · 翻译" class=author><a href=https://autoptr.top/license/ style=color:red title="All rights reserved · 译文或原创内容·版权所有" target=_blank rel=nofollow>&copy;</a><a href=https://autoptr.top/gdocr/GoldenDict-OCR-Deployment/ style=color:#007cd5 title="Installing GoldenDict++ Pro" target=_blank>&#128681;</a><a href=https://autoptr.top/ title="Back to Topics · 回主题页">&#127793;</a></span></h1><div align=center class=gdocr_topic_head style=color:#444;background-color:transparent;margin-bottom:.3em><style type=text/css>.gdocr_topic_head a{text-decoration:none;color:darkred;display:inline-block;border:1px solid #4e57ef;box-shadow:3px 4px #aaaab7;padding:1px;margin:2px 1px}</style><a href=/gdocr/GoldenDict-OCR-Free-Dictionaries/ style=color:#7f0099;font-weight:700 title=对辞书分享社区的态度 target=_blank>辞书分享</a>
<a href=/gdocr/GoldenDict-OCR-Portable-Mode/ style=color:#7f0099;font-weight:700 target=_blank>便携模式</a>
<a href=/gdocr/en/GoldenDict-OCR-Audio-Players/ target=_blank>音频引擎</a>
<a href=/gdocr/cn/GoldenDict-OCR-Adobe-Flash-Plugin/ style=color:#7f0099 target=_blank>播放动画</a>
<a href=/gdocr/en/GoldenDict-OCR-Web-History-Cache/ target=_blank>文章缓存</a>
<a href=/gdocr/en/GoldenDict-OCR-Group-by-Folders/ style=color:#7f0099;font-weight:700 target=_blank>自动分组</a>
<a href=/gdocr/en/GoldenDict-OCR-Reading-Mode/ target=_blank>阅读模式</a>
<a href=/gdocr/en/GoldenDict-OCR-QA-Help/ style=color:#7f0099;font-weight:700 target=_blank>问题帮助</a>
<a href=/gdocr/GoldenDict-OCR-Language-Settings/ target=_blank>划词设置</a>
<a href=/gdocr/GoldenDict-OCR-Deployment/ style=color:blue;font-weight:700 target=_blank>升级下载</a></div><p><span style=margin-left:2em></span>最近发布的GoldenDict++中禁用了个别特性 &mdash; 主要是早期为支持对词典内容的视频播放所做的部分实现，没想会收到学友反馈程序的查询速度变快了，这是我预料之外的。<style>.autoptr-aspect-ratio{position:relative;width:100%;height:0;padding-bottom:60%}#biliplayer{position:absolute;width:100%;height:100%;left:0;top:0}@media only screen and (min-device-width:320px) and (max-device-width:480px){.aspect-ratio #biliplayer{width:100%;height:100%}}</style><div align=center class=autoptr-aspect-ratio><iframe id=biliplayer src="//player.bilibili.com/player.html?bvid=BV1kv4y1L7Cm&page=1&high_quality=1&danmaku=0" scrolling=no border=0 frameborder=no framespacing=0 allowfullscreen loading=lazy></iframe></div></p><p><span style=margin-left:2em></span>压马路时候思考了一下，与视频播放支持相关的实现大致为两处：编译期预定义的参数影响了程序内的默认 mutex 的封装，其实也就是在C++11的内置 mutex 上的简单包装（最初的实现基于Qt Api），另一处就是使用正则在HTML代码中的替换处理。</p><p><span style=margin-left:2em></span>实现对词典内容中HTML标签 source 和 embed 等的支持，需要在用户查询过程中完成对视频内容的文件缓存处理，并替换内容源码中的视频链接为本地缓存的文件。<br><span style=margin-left:2em></span>当时只是为了能够快速且以尽可能少的侵入性修改来完成这一支持，实现特别的简单，但显然违反了原有的数据访问的排他性设计 &mdash; 带有视频标签的词典资源的读取导致了资源访问线程死锁。为了解决死锁问题，也只是简单的将原来的 std::mutex 替换为递归锁 std::recursive_mutex。</p><p><span style=margin-left:2em></span>只一行代码就解决了死锁的问题。随这一行代码，加上对HTML内容的正则处理多加了几个标签，性能下降肯定是会有的，但对查询用的总时间不会有很明显的影响 &mdash; 在用户体验上应是可被忽略的。</p><p><span style=margin-left:2em></span>对词条释义内容的读是异步多线程的（一词典至少一个读线程，除个别如EPWing格式，不同词典的线程间并无互通数据），但只有一个用户线程来组织（处理）这些数据，读线程结束前通知用户线程，用户线程将释义内容依词典分组中的顺序进行拼接 &mdash; 排序在前面的词典内容早到可以早拼接，所有的读线程执行完毕后用户线程才会完成访问过程并将查询结果以文章内容形式反馈给用户。<br><span style=margin-left:2em></span>依这一逻辑，<strong>同样的词典分组，如果用户将简单词典放在分组最前面的位置，内容多且结构复杂的词典和网络、应用程序型词典尽可能的放在分组后面，是可以提升查询效率的</strong>。</p><p><span style=margin-left:2em></span>我个人主用Windows，没有明显感觉，可能我的词典比较少比较简单吧。<br><span style=margin-left:2em></span>受馈信息来自使用 mac 的学友，我想或应是平台差异 &mdash; 在同样的实现下，Linux或Unix平台性能上应该是有明显的优势的，优化带来的效果应该也会比较明显吧。</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top · 回顶部" rel=nofollow>&#127772;2021-06-06 </a><a href=https://autoptr.top/license/ title="All rights reserved · 原创内容·版权所有" target=_blank rel=nofollow>&copy;</a></span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2025 AuTopTr 版权所有</a><a href=https://autoptr.top/ title="Back to Home · 回首页">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>标签:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><span>&nbsp;&nbsp;</span>
<span>分类:</span><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li><li><a class=link href=https://autoptr.top/categories/GoldenDict target=_blank>GoldenDict</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>