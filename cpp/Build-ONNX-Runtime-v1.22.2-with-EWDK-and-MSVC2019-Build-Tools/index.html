<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>使用 MSVC 2019 Build Tools 构建 ONNX Runtime v1.22.2</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="ONNX Runtime,MSVC2019,cmake,msvc2019,Windows"><meta name=description content="Windows 如何从源码安装 ONNX Runtime v1.22.2"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"🌜"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>使用 MSVC 2019 Build Tools 构建 ONNX Runtime v1.22.2</span><span class=btRight><span title="Translator · 翻译" class=author><a href=https://autoptr.top/license/ style=color:red title="All rights reserved · 译文或原创内容·版权所有" target=_blank rel=nofollow>&copy;</a><a href=.. title="Back to Topics · 回主题页">&#127793;</a></span></h1><h3 id=运行环境>运行环境</h3><ol><li>Enterprise Windows Driver Kit with Microsoft C++ 2019 Build Tools</li><li>独立安装<code>cmake-3.28.6-win32-x86</code>或更高版本</li><li>msys2 - 安装<code>python、git、tar、zip、p7z</code> 等工具</li></ol><h3 id=启动环境>启动环境</h3><ol><li>启动<code>EWDK</code>-<code>x64</code>或<code>x86</code>控制台，在其中执行<code>msys2_shell.cmd</code>(如下操作均在<code>msys2</code>的<code>shell</code>中执行)</li><li>检查编译所需开发组件</li></ol><blockquote><p>where cmake python nmake cl ml64 ml
nmake -? && cl</p></blockquote><ol start=3><li>如系统中存在多个易混淆的<code>cmake</code>和<code>python</code></li></ol><blockquote><p>通过在<code>shell</code>中设置<code>PATH</code>来确保<code>cmake</code>不能用<code>msys2</code>的，<br>而<code>python</code>要用<code>msys2</code>的</p></blockquote><h3 id=下载源码>下载源码</h3><ol start=4><li>检出<code>onnxruntime-1.22.2</code>代码</li></ol><blockquote><p>git clone -b rel-1.22.2 &ndash;recursive <a href=https://github.com/microsoft/onnxruntime.git>https://github.com/microsoft/onnxruntime.git</a></p></blockquote><ol start=5><li>进入<code>onnxruntime</code>代码目录</li></ol><blockquote><p>cd onnxruntime</p></blockquote><ol start=6><li>检出子模块代码</li></ol><blockquote><p>git submodule update &ndash;init &ndash;recursive</p></blockquote><h3 id=编译过程>编译过程</h3><ol><li>设置环境变量<code>build_dir</code>为编译工作目录，执行编译脚本</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>build_dir<span style=color:#f92672>=</span>./build_cpp_only
</span></span><span style=display:flex><span>python3 ./tools/ci_build/build.py <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --compile_no_warning_as_error <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --build_dir $build_dir <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --config Release <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --update --build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --build_shared_lib <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --cmake_generator <span style=color:#e6db74>&#34;NMake Makefiles&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --cmake_extra_defines onnxruntime_BUILD_UNIT_TESTS<span style=color:#f92672>=</span>OFF <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --cmake_extra_defines CMAKE_INSTALL_PREFIX<span style=color:#f92672>=</span>$build_dir/install/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --skip_tests 
</span></span></code></pre></div><ol start=2><li>如需自动安装，请在编译脚本后追加<code>--target install </code>项</li></ol><blockquote><p>下述需要干预编译过程，故忽略此步</p></blockquote><h3 id=干预protobuf的编译>干预<code>protobuf</code>的编译</h3><ol><li>打开<code>$build_dir/Release/_deps/protobuf-build/CMakeFiles/*.dir/flags.make</code></li><li>修改<code>CXX_FLAGS</code>中的<code>/MT</code>为<code>/MD</code></li><li>执行构建命令</li></ol><blockquote><p>cd $build_dir/Release && nmake</p></blockquote><h3 id=干预onnx的编译同样适应于debian版本>干预<code>onnx</code>的编译(同样适应于<code>Debian</code>版本)</h3><ol><li>打开<code>$build_dir/Release/_deps/onnx-build/CMakeFiles/*_proto.dir/build.make</code></li><li>修改<code>python.exe */onnx-src/onnx/gen_proto.py</code>为<code>python.exe ../onnx-src/onnx/gen_proto.py</code></li><li>执行构建命令</li></ol><blockquote><p>cd $build_dir/Release && nmake</p></blockquote><h3 id=干预32位x86版本mlas最高支持avx2的编译>干预<code>32</code>位(x86)版本<code>mlas</code>(最高支持<code>avx2</code>)的编译</h3><ol><li>打开<code>$build_dir/Release/CMakeFiles/onnxruntime_mlas..dir/build.make</code></li></ol><blockquote><p>删除所有<code>avx512</code>的<code>C++</code>编译内容和<code>amd64\*.asm</code>编译内容<br>添加<code>onnxruntime\core\mlas\lib\i386\*.asm</code>对应的编译内容</p></blockquote><ol start=2><li>修打开<code>$build_dir/Release/CMakeFiles/onnxruntime_mlas..dir/objects1.rsp</code></li></ol><blockquote><p>删除所有<code>avx512</code>的内容和<code>amd64\*.asm</code>内容<br>追加<code>onnxruntime\core\mlas\lib\i386\*.asm</code>对应的内容</p></blockquote><ol start=3><li>修打开<code>onnxruntime\core\mlas\lib\amx_common.h</code>源码</li></ol><blockquote><p>在<code>#ifdef _WIN32</code>和<code>#define tile_dpbssd*</code>之间添加如下内容</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#if !defined (_M_X64)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// AMX
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>int</span> __tile;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_loadconfig</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_storeconfig</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_release</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_loadd</span>(__tile dst, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>base, <span style=color:#66d9ef>int</span> stride);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_stream_loadd</span>(__tile dst, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>base, <span style=color:#66d9ef>int</span> stride);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_stored</span>(__tile src, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>base, <span style=color:#66d9ef>int</span> stride);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_zero</span>(__tile dst);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_dpbf16ps</span>(__tile dst, __tile src1, __tile src2);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_dpbssd</span>(__tile dst, __tile src1, __tile src2);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_dpbsud</span>(__tile dst, __tile src1, __tile src2);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_dpbusd</span>(__tile dst, __tile src1, __tile src2);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>_tile_dpbuud</span>(__tile dst, __tile src1, __tile src2);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#endif  </span><span style=color:#75715e>/* defined (_M_X64) */</span><span style=color:#75715e>
</span></span></span></code></pre></div><ol start=4><li>执行构建命令</li></ol><blockquote><p>cd $build_dir/Release && nmake</p></blockquote><h3 id=干预onnxruntime_generate_def的编译>干预<code>onnxruntime_generate_def</code>的编译</h3><ol><li>打开<code>$build_dir/Release/CMakeFiles/onnxruntime_generate_def.dir/build.make</code></li><li>修改<code>python3 */tools/ci_build/gen_def.py</code>为<code>python3 ../../tools/ci_build/gen_def.py</code></li><li>执行构建命令</li></ol><blockquote><p>cd $build_dir/Release && nmake</p></blockquote><h3 id=安装开发文件>安装开发文件</h3><blockquote><p>cd $build_dir/Release && nmake install</p></blockquote><h3 id=debian-版本>Debian 版本</h3><ol><li>下载<a href=https://cmake.org/files/v3.28/cmake-3.28.6-linux-x86_64.tar.gz>cmake-3.28.6-linux-x86_64.tar.gz</a></li><li>解压后将<code>cmake-3.28.6-linux-x86_64/bin</code>添加到<code>PATH</code>前面</li><li>准备源码，设置环境变量<code>build_dir</code>，执行编译脚本</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>build_dir<span style=color:#f92672>=</span>./build_cpp_only
</span></span><span style=display:flex><span>python3 ./tools/ci_build/build.py <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --compile_no_warning_as_error <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --build_dir $build_dir <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --config Release <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --update --build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --build_shared_lib <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --cmake_generator <span style=color:#e6db74>&#34;Unix Makefiles&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --cmake_extra_defines onnxruntime_BUILD_UNIT_TESTS<span style=color:#f92672>=</span>OFF <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --cmake_extra_defines CMAKE_INSTALL_PREFIX<span style=color:#f92672>=</span>$build_dir/install/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --skip_tests 
</span></span></code></pre></div><ol start=4><li>干预<code>onnx</code>的编译同<code>msvc2019</code>版本</li></ol><blockquote><p>如有多个<code>python</code>版本，确保运行<code>python3</code></p></blockquote><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top · 回顶部" rel=nofollow>&#127772;2025-08-31 </a><a href=https://autoptr.top/license/ title="All rights reserved · 原创内容·版权所有" target=_blank rel=nofollow>&copy;</a></span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2025 AuTopTr 版权所有</a><a href=https://autoptr.top/ title="Back to Home · 回首页">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>标签:</span><li><a class=link href=https://autoptr.top/tags/ONNX target=_blank>ONNX</a></li><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/C target=_blank>C</a></li><li><a class=link href=https://autoptr.top/tags/OCR target=_blank>OCR</a></li><span>&nbsp;&nbsp;</span>
<span>分类:</span><li><a class=link href=https://autoptr.top/categories/Notes target=_blank>Notes</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li><li><a class=link href=https://autoptr.top/categories/%e5%88%92%e8%af%8d target=_blank>划词</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>