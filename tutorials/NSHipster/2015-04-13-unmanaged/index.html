<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>Unmanaged</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="Unmanaged,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="Unmanaged,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"ğŸŒœ"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>Unmanaged</span><span class=btRight><span title="Author Â· ä½œè€…" class=author>Nate Cook</span> <span title="Translator Â· ç¿»è¯‘" class=author>Croath Liu</span> <a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post Â· å…³è”æˆ–è½¬è½½å¼•ç”¨çš„æ–‡ç« " target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics Â· å›ä¸»é¢˜é¡µ">&#127793;</a></span></h1><p>API å¯¹äºå¼€å‘è€…æ¥è¯´ä¸åªæ˜¯æŠŠåŠŸèƒ½ç‚¹æ¥å£æš´éœ²å‡ºæ¥è€Œå·²ï¼ŒåŒæ—¶ä¹Ÿä¼ è¾¾ç»™æˆ‘ä»¬ä¸€äº›å…¶ä»–çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´æ¥å£å¦‚ä½•ä»¥åŠä¸ºä»€ä¹ˆè¦ä½¿ç”¨æŸäº›å€¼ã€‚å› ä¸ºè¦ä¼ è¾¾è¿™äº›ä¿¡æ¯ï¼Œç»™ä¸œè¥¿èµ·é€‚å½“çš„åå­—è¿™ä»¶äº‹æ‰å˜æˆäº†è®¡ç®—æœºç§‘å­¦ä¸­æœ€éš¾çš„éƒ¨åˆ†ä¹‹ä¸€ï¼Œè€Œè¿™ä¹Ÿæˆä¸ºå¥½çš„ API å’Œä¸å¥½çš„ API çš„é‡è¦åŒºåˆ«ã€‚</p><p>é€šè¿‡ Swift æ ‡å‡†åº“å°±å¯ä»¥çœ‹å‡ºï¼ŒSwift åœ¨å®‰å…¨æ€§å’Œå¯é æ€§æ–¹é¢å’Œä¸ Objective-C äº’é€šæ€§ä¹‹é—´æ–¹é¢æœ‰ç€æ˜æ˜¾çš„ç•Œçº¿ã€‚åƒ <code>Int</code>ã€<code>String</code> å’Œ <code>Array</code> è¿™äº›ç±»å‹åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­éƒ½ä¼šè¡¨ç°å‡ºç›´æ¥ä¸”æ— æ­§ä¹‰çš„è¡Œä¸ºï¼Œä½†å¦‚æœä»€ä¹ˆéƒ½ä¸è€ƒè™‘å°±åˆ›å»º <code>UnsafeMutablePointer</code> æˆ– <code>Unmanaged</code> ç­‰ç±»å‹çš„å®ä¾‹ï¼Œé‚£ææ€•å°±è¦è¸©åˆ°å‘é‡Œäº†ã€‚</p><p>è¿™æ¬¡æˆ‘ä»¬å…³æ³¨ <code>Unmanaged</code> è¿™ä¸ªå…³é”®å­—ã€‚<code>Unmanaged</code> è¡¨ç¤ºå¯¹ä¸æ¸…æ™°çš„å†…å­˜ç®¡ç†å¯¹è±¡çš„å°è£…ï¼Œä»¥åŠç”¨çƒ«æ‰‹å±±èŠ‹çš„æ–¹å¼æ¥ç®¡ç†ä»–ä»¬ã€‚ä½†å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹å†å²ã€‚</p><h2 id=è‡ªåŠ¨å¼•ç”¨è®¡æ•°automatic-reference-counting>è‡ªåŠ¨å¼•ç”¨è®¡æ•°ï¼ˆAutomatic Reference Countingï¼‰</h2><p>åœ¨çŸ³å™¨æ—¶ä»£ï¼ˆæˆ‘æ˜¯è¯´ 2011 å¹´ï¼‰ï¼Œåœ¨ Objective-C ä¸­è¿˜è¦æ‰‹åŠ¨è¿›è¡Œå¼•ç”¨è®¡æ•°ã€‚æ¯ä¸€ä¸ª retain æ“ä½œçš„å¼•ç”¨éƒ½è¦ä¸ä¸€ä¸ªç›¸åº”çš„ release æ“ä½œæ„æˆä¸€ä¸ªå¹³è¡¡çš„ç»„åˆï¼Œæ‰èƒ½é¿å…åº”ç”¨åœ¨åœºæ™¯åˆ‡æ¢çš„è¿‡ç¨‹ä¸­äº§ç”Ÿåƒµå°¸å¼•ç”¨å’Œå†…å­˜æ³„æ¼&mldr;&mldr;å¥½è„ã€‚å¯¹äºå·¥ç¨‹å¸ˆæ¥è¯´éœ€è¦å°å¿ƒåœ°è®¡ç®—æ¯ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å®åœ¨æ˜¯å¤ªç´¯äº†ï¼Œè€Œä¸”å¯¹äºæ–°å…¥è¡Œè€…é—¨æ§›ä¹Ÿè¿‡é«˜äº†ã€‚</p><p>è‡ªåŠ¨å¼•ç”¨è®¡æ•°ï¼ˆARCï¼‰çš„åˆ°æ¥è®©å’Œæ‰‹åŠ¨å†…å­˜ç®¡ç†ç›¸å…³çš„ä¸€åˆ‡éƒ½å¤±å»äº†å¿…è¦ã€‚åœ¨ ARC ä¸‹ï¼Œç¼–è¯‘å™¨ä¼šåœ¨æ¯ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸå†…æŒ‰ç…§è§„åˆ™å¸®ä½ è¿›è¡Œ <code>retain</code>/<code>release</code>/<code>autorelease</code> æŒ‡ä»¤çš„è°ƒç”¨ï¼Œå‡å°‘äº†å¾ˆå¤šéº»çƒ¦ã€‚<a href=https://developer.apple.com/library/mac/releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html>è¿™å¹…å›¾</a> ç»å¯¹ä¼šè®©ä½ æ„Ÿå—åˆ°æŠ›å¼ƒæ‰‹åŠ¨å†…å­˜ç®¡ç†çš„ç›Šå¤„ï¼š</p><p><img alt="ARC å‡ºç°å‰åå†…å­˜ç®¡ç†å·®å¼‚" src=/media/NSHipster/unmanaged-arc.png></p><p>åœ¨ç°åœ¨è¿™ä¸ªå ARC çš„ä¸–ç•Œé‡Œï¼Œæ‰€æœ‰çš„ Objective-C å’Œ ä» Objective-C æ–¹æ³•è¿”å›çš„ Core Foundation ç±»å‹çš„å†…å­˜éƒ½è¢«è‡ªåŠ¨ç®¡ç†ï¼Œåªå‰©ä¸‹ç”± C å‡½æ•°è¿”å›çš„ Core Foundation ç±»å‹è¿˜æ²¡æœ‰æ”¶ç¼–ã€‚å¯¹äºåè€…è€Œè¨€ï¼Œå¯¹è±¡æ‰€æœ‰æƒçš„ç®¡ç†ä»ç„¶åœç•™åœ¨è°ƒç”¨ <code>CFRetain()</code> å’Œ <code>CFRelease()</code>ã€æˆ–é€šè¿‡æŸä¸ª <code>__bridge</code> å‡½æ•°æ¡¥æ¥åˆ° Objective-C å¯¹è±¡çš„æ–¹å¼çš„å±‚é¢ä¸Šã€‚</p><p>ä¸ºäº†å¸®åŠ©å¤§å®¶ç†è§£ C å‡½æ•°è¿”å›å¯¹è±¡æ˜¯å¦è¢«è°ƒç”¨è€…æŒæœ‰ï¼Œè‹¹æœä½¿ç”¨äº† <em>Create è§„åˆ™</em> å’Œ <em>Get è§„åˆ™</em> å‘½åæ³•ï¼š</p><ul><li><p><strong>Create è§„åˆ™</strong> çš„æ„æ€æ˜¯ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°çš„åå­—å«æœ‰ <code>Create</code> æˆ– <code>Copy</code> ï¼Œå‡½æ•°çš„è¿”å›å€¼è¢«å‡½æ•°çš„è°ƒç”¨è€…æŒæœ‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨ <code>Create</code> æˆ– <code>Copy</code> å‡½æ•°çš„å¯¹è±¡åº”è¯¥å¯¹è¿”å›å¯¹è±¡è°ƒç”¨ <code>CFRelease</code> è¿›è¡Œé‡Šæ”¾ã€‚</p></li><li><p><strong>Get è§„åˆ™</strong> åˆ™ä¸åƒ Create è§„åˆ™ä¸€æ ·èƒ½ä»å‘½åè§„åˆ™çœ‹å‡ºè§„å¾‹ã€‚æˆ–è®¸å¯ä»¥æè¿°æˆå‡½æ•°åä¸å«æœ‰ <code>Create</code> æˆ– <code>Copy</code> çš„å‡½æ•°ï¼Ÿè¿™ç§å‡½æ•°éµå®ˆ Get è§„åˆ™ï¼Œè¿”å›å¯¹è±¡çš„æŒæœ‰è€…ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚å¦‚æœæƒ³æŒä¹…åŒ–ä¸€ä¸ªè¿”å›å¯¹è±¡ï¼Œå¤§å¤šæ•°æ—¶å€™å°±æ˜¯ä½ è‡ªå·±æ‰‹åŠ¨ retain å®ƒã€‚</p></li></ul><blockquote><p>å¦‚æœä½ æ˜¯ä¸€ä¸ªåƒæˆ‘ä¸€æ ·ç³»ä¸‰æ¡çš®å¸¦éƒ½æ€•è£¤å­æ‰ä¸‹æ¥çš„é‚£ç§å¼€å‘è€…ï¼Œé‚£å°±å»å¥½å¥½çœ‹çœ‹æ–‡æ¡£ã€‚å³ä½¿å¤§å¤šæ•° API éµä»è¿™ç§å‘½åè§„åˆ™ï¼Œä»¥é˜²æ„å¤–æƒ…å†µï¼Œç”¨çš„æ—¶å€™éƒ½åº”è¯¥å¥½å¥½çœ‹çœ‹æ–‡æ¡£ç¡®è®¤ä¸€ä¸‹ã€‚</p></blockquote><p>ç­‰ç­‰ï¼ç­‰ç­‰ï¼æˆ‘ä»¬è¿™ç¯‡æ–‡ç« æ˜¯è®¨è®º <em>Swift</em> çš„ï¼Œå›åˆ°æ­£è½¨ï¼</p><p>Swift ä»…æ”¯æŒ ARCï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰åœ°æ–¹è°ƒç”¨ <code>CFRelease</code> æˆ– <code>__bridge_retained</code>ã€‚é‚£ä¹ˆ Swift æ˜¯å¦‚ä½•è®©è¿™ç§ â€œåœ¨ä¸Šä¸‹æ–‡ä¸­å†…å­˜ç®¡ç†â€ çš„å“²å­¦èå…¥è‡ªå·±çš„å†…å­˜å®‰å…¨ä½“ç³»å‘¢ï¼Ÿ</p><p>äº‹æƒ…åˆ†ä¸¤ç§æƒ…å†µã€‚<em>æ³¨æ˜</em> çš„ APIï¼ŒSwift èƒ½å¤Ÿåœ¨ä¸Šä¸‹æ–‡ä¸­ä¸¥æ ¼éµå¾ªæ³¨é‡Šæè¿°å¯¹ CoreFoundation API è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œå¹¶ä»¥åŒæ ·å†…å­˜å®‰å…¨çš„æ–¹å¼æ¡¥æ¥åˆ° Objective-C æˆ– Swift ç±»å‹ä¸Šã€‚å¯¹äºæ²¡æœ‰æ˜ç¡®æ³¨æ˜çš„ APIï¼ŒSwift åˆ™ä¼šé€šè¿‡ <code>Unmanaged</code> ç±»å‹æŠŠå·¥ä½œäº¤ç»™å¼€å‘è€…ã€‚</p><h2 id=ç®¡ç†-unmanaged>ç®¡ç† <code>Unmanaged</code></h2><p>è™½ç„¶å¤§å¤šæ•°çš„ CoreFoundation API éƒ½æœ‰æ³¨æ˜æ˜¯å¦å¯è‡ªåŠ¨ç®¡ç†ï¼Œä½†ä¸€äº›é‡è¦çš„éƒ¨åˆ†è¿˜æ²¡æœ‰å¾—åˆ°å……åˆ†é‡è§†ã€‚è¿™ç¯‡æ–‡ç« ç¼–å†™æ—¶ï¼ŒAddress Book framework çš„ API ä¼¼ä¹æ˜¯æ¯”è¾ƒé‡è¦çš„å°šæœªæ³¨æ˜çš„éƒ¨åˆ†ï¼Œæœ‰ä¸€äº›å‡½æ•°è¿˜è¦ä¼ å…¥æˆ–è¿”å› <code>Unmanaged</code> ç±»å‹çš„å¯¹è±¡ã€‚</p><p>ä¸€ä¸ª <code>Unmanaged&lt;T></code> å®ä¾‹å°è£…æœ‰ä¸€ä¸ª CoreFoundation ç±»å‹ <code>T</code>ï¼Œå®ƒåœ¨ç›¸åº”èŒƒå›´å†…æŒæœ‰å¯¹è¯¥ <code>T</code> å¯¹è±¡çš„å¼•ç”¨ã€‚ä»ä¸€ä¸ª <code>Unmanaged</code> å®ä¾‹ä¸­è·å–ä¸€ä¸ª Swift å€¼çš„æ–¹æ³•æœ‰ä¸¤ç§ï¼š</p><blockquote><ul><li><code>takeRetainedValue()</code>ï¼šè¿”å›è¯¥å®ä¾‹ä¸­ Swift ç®¡ç†çš„å¼•ç”¨ï¼Œå¹¶åœ¨è°ƒç”¨çš„åŒæ—¶å‡å°‘ä¸€æ¬¡å¼•ç”¨æ¬¡æ•°ï¼Œæ‰€ä»¥å¯ä»¥æŒ‰ç…§ Create è§„åˆ™æ¥å¯¹å¾…å…¶è¿”å›å€¼ã€‚</li></ul></blockquote><blockquote><ul><li><code>takeUnretainedValue()</code>ï¼šè¿”å›è¯¥å®ä¾‹ä¸­ Swift ç®¡ç†çš„å¼•ç”¨è€Œ <em>ä¸å‡å°‘</em> å¼•ç”¨æ¬¡æ•°ï¼Œæ‰€ä»¥å¯ä»¥æŒ‰ç…§ Get è§„åˆ™æ¥å¯¹å¾…å…¶è¿”å›å€¼ã€‚</li></ul></blockquote><p>åœ¨å®è·µä¸­æœ€å¥½ä¸è¦ç›´æ¥æ“ä½œ <code>Unmanaged</code> å®ä¾‹ï¼Œè€Œæ˜¯ç”¨è¿™ä¸¤ä¸ª <code>take</code> å¼€å¤´çš„æ–¹æ³•ä»è¿”å›å€¼ä¸­æ‹¿åˆ°ç»‘å®šçš„å¯¹è±¡ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬è¿™é‡Œè¦åˆ›å»ºä¸€ä¸ª <code>ABAddressBook</code> æ¥è·å–ç”¨æˆ·æœ€å¥½çš„æœ‹å‹çš„åå­—ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> bestFriendID = ABRecordID(...)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create Rule - retained</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> addressBook: ABAddressBook = ABAddressBookCreateWithOptions(<span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>).takeRetainedValue()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Get Rule - unretained</span>
</span></span><span style=display:flex><span>    bestFriendRecord: ABRecord = ABAddressBookGetPersonWithRecordID(addressBook, bestFriendID)?.takeUnretainedValue(),
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create Rule (Copy) - retained</span>
</span></span><span style=display:flex><span>    name = ABRecordCopyCompositeName(bestFriendRecord)?.takeRetainedValue() <span style=color:#66d9ef>as</span>? String
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    println(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>\(</span>name<span style=color:#e6db74>)</span><span style=color:#e6db74>: BFF!&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Rhonda Shorsheimer: BFF!</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é€šè¿‡ä½¿ç”¨ Swift 1.2 æ–°å¢çš„ optional ç»‘å®šï¼Œå–å¾—å¯¹è±¡å¹¶å°†å…¶è½¬åŒ–ä¸º Swift ç±»å‹ç®€ç›´æ˜¯å°èœä¸€ç¢Ÿã€‚</p><h2 id=æœ€å¥½çš„è§£å†³é—®é¢˜çš„æ–¹æ³•æ˜¯é¿å…é‡åˆ°é—®é¢˜>æœ€å¥½çš„è§£å†³é—®é¢˜çš„æ–¹æ³•æ˜¯é¿å…é‡åˆ°é—®é¢˜</h2><p>ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•å¯¹ä»˜ <code>Unmanaged</code> äº†ï¼Œç°åœ¨æˆ‘ä»¬è¿˜æ˜¯çœ‹çœ‹å¦‚ä½•é¿å…ç¢°åˆ°è¿™ç§æƒ…å†µå§ã€‚å¦‚æœ <code>Unmanaged</code> å¼•ç”¨æ˜¯ä»ä½ è‡ªå·±å†™çš„ C å‡½æ•°è¿”å›çš„ï¼Œé‚£ä¹ˆä½ æœ€å¥½è¿˜æ˜¯æ³¨æ˜ä¸€ä¸‹ã€‚è¿™ç§æ³¨é‡Šèƒ½å¤Ÿå¸®åŠ©ç¼–è¯‘å™¨ç†è§£å¦‚ä½•è‡ªåŠ¨ç®¡ç†ä½ æ‰€è¿”å›å¯¹è±¡çš„å†…å­˜ï¼šå°±ä¸è¦ç”¨ <code>Unmanaged&lt;CFString></code> äº†ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªåœ¨ Swift ä¸­ç±»å‹å®‰å…¨ä»¥åŠå†…å­˜ç®¡ç†å®Œå–„çš„ <code>CFString</code> ç±»å‹ã€‚</p><p>ä¸¾ä¾‹è¯´æ˜ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•°èƒ½å°†ä¸¤ä¸ª <code>CFString</code> å¯¹è±¡æ‹¼è£…æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”è¦å‘Šè¯‰ Swift è¿™ä¸ªè¿”å›å­—ç¬¦ä¸²çš„å†…å­˜æ˜¯è¢«å¦‚ä½•ç®¡ç†çš„ã€‚æ ¹æ®ä¸Šé¢æåˆ°çš„å‘½åè§„åˆ™ï¼Œæˆ‘ä»¬çš„å‡½æ•°åº”è¯¥å«åš <code>CreateJoinedString</code> â€”â€” è¿™ä¸ªåå­—è¡¨è¾¾çš„æ„æ€æ˜¯è°ƒç”¨è€…å°†æŒæœ‰è¿”å›å€¼ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CFStringRef <span style=color:#a6e22e>CreateJoinedString</span>(CFStringRef string1, CFStringRef string2);
</span></span></code></pre></div><p>æ—¢ç„¶è¿™æ ·ï¼Œåœ¨å‡½æ•°å®ç°ä¸­æˆ‘ä»¬ç”¨ <code>CFStringCreateMutableCopy</code> åˆ›å»ºçš„ <code>resultString</code> è¿”å›æ—¶æ²¡æœ‰ä¸å…¶åˆ›å»ºå‡½æ•°å¹³è¡¡çš„ <code>CFRelease</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CFStringRef <span style=color:#a6e22e>CreateJoinedString</span>(CFStringRef string1, CFStringRef string2) {
</span></span><span style=display:flex><span>    CFMutableStringRef resultString <span style=color:#f92672>=</span> <span style=color:#a6e22e>CFStringCreateMutableCopy</span>(NULL, <span style=color:#ae81ff>0</span>, string1);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CFStringAppend</span>(resultString, string2);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resultString;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨ Swift ä¸­åƒä¸Šé¢ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿè¦æ‰‹åŠ¨ç®¡ç†å†…å­˜ã€‚æˆ‘ä»¬çš„å‡½æ•°è¢«å¼•ç”¨æˆè¿”å›ä¸€ä¸ª <code>Unmanaged&lt;CFString>!</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// imported declaration:</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CreateJoinedString</span>(string1: CFString!, string2: CFString!) -&gt; Unmanaged&lt;CFString&gt;<span style=color:#f92672>!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// to call:</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> joinedString = CreateJoinedString(<span style=color:#e6db74>&#34;First&#34;</span>, <span style=color:#e6db74>&#34;Second&#34;</span>).takeRetainedValue() <span style=color:#66d9ef>as</span> String
</span></span></code></pre></div><p>æ—¢ç„¶æˆ‘ä»¬çš„å‡½æ•°éµå¾ªäº† Create è§„åˆ™è¿›è¡Œå‘½åï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰“å¼€ç¼–è¯‘å™¨çš„éšå¼æ¡¥æ¥æ¥æ¶ˆé™¤ <code>Unmanaged</code> æ­§ä¹‰ã€‚Core Foundation æä¾›äº†ä¸¤ä¸ªå®ï¼š<code>CF_IMPLICIT_BRIDGING_ENABLED</code> å’Œ <code>CF_IMPLICIT_BRIDGING_DISABLED</code> â€”â€” ç”¨æ¥æ‰“å¼€å’Œå…³é—­ Clang çš„ <code>arc_cf_code_audited</code> å˜é‡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CF_IMPLICIT_BRIDGING_ENABLED            <span style=color:#75715e>// get rid of Unmanaged
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#pragma clang assume_nonnull begin      </span><span style=color:#75715e>// also get rid of !s
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>CFStringRef <span style=color:#a6e22e>CreateJoinedString</span>(CFStringRef string1, CFStringRef string2);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#pragma clang assume_nonnull end
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>CF_IMPLICIT_BRIDGING_DISABLED
</span></span></code></pre></div><p>ç°åœ¨ Swift å·²ç»èƒ½å¤Ÿæ§åˆ¶è¿™ä¸ªå‡½æ•°è¿”å›å€¼çš„å†…å­˜ç®¡ç†äº†ï¼Œæˆ‘ä»¬çš„ä»£ç é‡Œä¹Ÿå¯ä»¥ä¸ç”¨ <code>Unmanaged</code> äº†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// imported declaration:</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CreateJoinedString</span>(string1: CFString, string2: CFString) -&gt; CFString
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// to call:</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> joinedString = CreateJoinedString(<span style=color:#e6db74>&#34;First&#34;</span>, <span style=color:#e6db74>&#34;Second&#34;</span>) <span style=color:#66d9ef>as</span> String
</span></span></code></pre></div><p>æœ€åä¸€ç‚¹ï¼Œå¦‚æœä½ çš„å‡½æ•° <em>æ²¡æœ‰ä½¿ç”¨</em> Create/Get è§„åˆ™æ¥å‘½åï¼Œé‚£ä¹ˆæ˜æ˜¾åœ°ï¼Œä½ æŠŠè¿™äº›å‡½æ•°ç”¨è¿™ä¸ªæ³•åˆ™é‡æ–°å‘½åä¸€æ¬¡ã€‚å½“ç„¶åœ¨çœŸå®æƒ…å†µä¸‹è¿™ç§ä¿®æ”¹å¯èƒ½å¹¶ä¸å®¹æ˜“ï¼Œä½†æ˜¯æ‹¥æœ‰æ˜ç¡®æ€§ä¸€è‡´æ€§è¿”å›çš„ API çš„å¥½å¤„ä¸ä»…ä»…æ˜¯é¿å… <code>Unmanaged</code>ã€‚å¦‚æœä¸èƒ½å¤Ÿé‡å‘½åï¼Œä¹Ÿæœ‰å¦å¤–ä¸¤ç§æ³¨æ˜æ–¹å¼å¯ä»¥ä½¿ç”¨ï¼šå°†æŒæœ‰è€…è½¬ç§»åˆ°è°ƒç”¨è€…çš„å‡½æ•°åº”è¯¥ä½¿ç”¨ <code>CF_RETURNS_RETAINED</code>ï¼Œåä¹‹åˆ™ä½¿ç”¨ <code>CF_RETURNS_NOT_RETAINED</code>ã€‚æ¯”å¦‚è¯´ï¼Œè¿™ä¸ªå‘½åç³Ÿç³•çš„ <code>MakeJoinedString</code> å°±æ˜¯ç”¨äº†æ‰‹åŠ¨æ³¨æ˜çš„æ–¹å¼æ¥è¡¨æ˜å…¶æ€§è´¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CF_RETURNS_RETAINED
</span></span><span style=display:flex><span>__nonnull CFStringRef <span style=color:#a6e22e>MakeJoinedString</span>(__nonnull CFStringRef string1,
</span></span><span style=display:flex><span>                                       __nonnull CFStringRef string2);
</span></span></code></pre></div><hr><p>ä½ å¯èƒ½æ„Ÿè§‰ <code>Unmanaged</code> åªæ˜¯ä¸€æ—¶çš„æƒå®œä¹‹è®¡ â€”â€” æ˜¯çš„ç¡®å®ï¼Œå› ä¸ºå¯¹ CoreFoundation ä¸­æ•°é‡åºå¤§çš„ API è¿›è¡Œæ ‡æ³¨çš„å·¥ä½œè¿˜åœ¨è¿›è¡Œä¸­ã€‚éšç€å‡½æ•°çš„äº¤äº’å½¢å¼è¢«ä¿®æ”¹å¾—è¶Šæ¥è¶Šæ¸…æ™°ï¼Œæ¯ä¸€ä»£ Xcode å‘å¸ƒéƒ½æœ‰å¯èƒ½éœ€è¦ä½ å‡å°‘å¯¹ <code>takeRetainedValue()</code> çš„è°ƒç”¨ã€‚åœ¨æœ€åä¸€ä¸ª <code>CFUnannotatedFunctionRef</code> è¢«æ”¹å¥½ä¹‹å‰ï¼Œ<code>Unmanaged</code> å°†ä¼šå¸®åŠ©ä½ æ¸¡è¿‡éš¾å…³ã€‚</p><hr><p>é™¤é<a href=https://nshipster.cn/ target=_blank>å¦æœ‰å£°æ˜</a>ï¼Œæœ¬æ–‡é‡‡ç”¨çŸ¥è¯†å…±äº«ã€Œ<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>ç½²å-éå•†ä¸šæ€§ä½¿ç”¨ 3.0 ä¸­å›½å¤§é™†</a>ã€è®¸å¯åè®®æˆæƒã€‚</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top Â· å›é¡¶éƒ¨" rel=nofollow>&#127772;2015-04-13 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2026 Nate Cook ç‰ˆæƒæ‰€æœ‰</a><a href=https://autoptr.top/ title="Back to Home Â· å›é¦–é¡µ">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>æ ‡ç­¾:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>åˆ†ç±»:</span><li><a class=link href=https://autoptr.top/categories/Swift target=_blank>Swift</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>