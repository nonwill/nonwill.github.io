<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>guard & defer</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="guard & defer,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="guard & defer,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"ğŸŒœ"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>guard & defer</span><span class=btRight><span title="Author Â· ä½œè€…" class=author>Mattt & Nate Cook</span> <span title="Translator Â· ç¿»è¯‘" class=author><a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post Â· å…³è”æˆ–è½¬è½½å¼•ç”¨çš„æ–‡ç« " target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics Â· å›ä¸»é¢˜é¡µ">&#127793;</a></span></h1><blockquote><p>ã€Œæˆ‘ä»¬åº”è¯¥ï¼ˆèªæ˜çš„ç¨‹åºå‘˜æ˜ç™½è‡ªå·±çš„å±€é™æ€§ï¼‰å°½åŠ›â€¦â€¦è®©æ–‡æœ¬é‡Œçš„ç¨‹åºï¼ˆprogramï¼‰å’Œæ—¶é—´è½´ä¸Šçš„è¿›ç¨‹ï¼ˆprocessï¼‰çš„å¯¹åº”å°½é‡ç®€å•ã€‚ã€</p><p>â€”<a href=https://en.wikipedia.org/wiki/Edsger_W._Dijkstra>Edsger W. Dijkstra</a>,
<a href=https://homepages.cwi.nl/~storm/teaching/reader/Dijkstra68.pdf>ã€ŠGo To æœ‰å®³è®ºã€‹</a></p></blockquote><p>å¾ˆé—æ†¾ï¼Œä»–çš„æ–‡ç« é€šå¸¸åªå› ä¸ºä½¿ã€Š____æœ‰å®³è®ºã€‹è¿™ç§æ–‡ç« æ ‡é¢˜åœ¨ç¨‹åºå‘˜ä¸­æµè¡Œèµ·æ¥ï¼Œè¿˜æœ‰ç½‘ä¸Šå¯¹è¿™äº›è®ºæ–‡ä¸å¦¥å½“çš„æŠ¨å‡»å‡ºç°æ—¶ï¼Œæ‰ä¼šè¢«æƒ³èµ·ã€‚å› ä¸º Dijkstraï¼ˆç…§å¸¸ï¼‰æå‡ºäº†ä¸€ä¸ªå¾ˆå¥½çš„è§‚ç‚¹ï¼š<strong>ä»£ç ç»“æ„åº”è¯¥åæ˜ å…¶è¡Œä¸ºã€‚</strong></p><p>Swift 2.0 å¸¦æ¥äº†ä¸¤ä¸ªæ–°çš„èƒ½å¤Ÿç®€åŒ–ç¨‹åºå’Œæé«˜æ•ˆç‡çš„æ§åˆ¶æµè¡¨è¾¾å½¢å¼ï¼š<code>guard</code> å’Œ <code>defer</code>ã€‚å‰è€…å¯ä»¥è®©ä»£ç ç¼–å†™æ›´æµç•…ï¼Œåè€…èƒ½å¤Ÿè®©æ‰§è¡Œæ¨è¿Ÿã€‚</p><p>æˆ‘ä»¬åº”è¯¥å¦‚ä½•ä½¿ç”¨è¿™ä¸¤ä¸ªæ–°çš„å£°æ˜æ–¹å¼å‘¢ï¼Ÿ<code>guard</code> å’Œ <code>defer</code> å°†å¦‚ä½•å¸®æˆ‘ä»¬å˜æ¸…ç¨‹åºå’Œè¿›ç¨‹é—´çš„å¯¹åº”å…³ç³»å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬ deferï¼ˆæ¨è¿Ÿï¼‰ä¸€ä¸‹ <code>defer</code> å…ˆçœ‹ <code>guard</code>ã€‚</p><hr><h2 id=guard>guard</h2><p><code>guard</code> æ˜¯ä¸€ä¸ªè¦æ±‚è¡¨è¾¾å¼çš„å€¼ä¸º <code>true</code> ä»è€Œç»§ç»­æ‰§è¡Œçš„æ¡ä»¶è¯­å¥ã€‚å¦‚æœè¡¨è¾¾å¼ä¸º <code>false</code>ï¼Œåˆ™ä¼šæ‰§è¡Œå¿…é¡»æä¾›çš„ <code>else</code> åˆ†æ”¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sayHello</span>(numberOfTimes: Int) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>guard</span> numberOfTimes <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>_</span> <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>1.</span>..numberOfTimes {
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Hello!&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>guard</code> è¯­å¥ä¸­çš„ <code>else</code> åˆ†æ”¯å¿…é¡»é€€å‡ºå½“å‰çš„åŒºåŸŸï¼Œé€šè¿‡ä½¿ç”¨ <code>return</code> æ¥é€€å‡ºå‡½æ•°ï¼Œ<code>continue</code> æˆ–è€… <code>break</code> æ¥é€€å‡ºå¾ªç¯ï¼Œæˆ–è€…ä½¿ç”¨åƒ <code>fatalError(_:file:line:)</code> è¿™ç§è¿”å› <a href=https://nshipster.com/never><code>Never</code></a> çš„å‡½æ•°ã€‚</p><p><code>guard</code> è¯­å¥å’Œ optional ç»‘å®šç»„åˆåœ¨ä¸€èµ·éå¸¸å¥½ç”¨ã€‚åœ¨ <code>guard</code> è¯­å¥çš„æ¡ä»¶é‡Œè¿›è¡Œçš„ optional ç»‘å®šå¯ä»¥åœ¨å‡½æ•°æˆ–é—­åŒ…å…¶åçš„éƒ¨åˆ†ä½¿ç”¨ã€‚</p><p>å¯¹æ¯”ä¸€ä¸‹ <code>guard-let</code> è¯­å¥å’Œ <code>if-let</code> è¯­å¥ä¸­çš„ optional ç»‘å®šï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>var</span> name: String?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> name = name {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// name åœ¨è¿™é‡Œé¢ä¸æ˜¯ optionalï¼ˆç±»å‹æ˜¯ Stringï¼‰</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// name åœ¨å¤–é¢æ˜¯ optionalï¼ˆç±»å‹æ˜¯ String?ï¼‰</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>guard</span> <span style=color:#66d9ef>let</span> name = name <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// name ä»è¿™é‡Œå¼€å§‹éƒ½ä¸æ˜¯ optional äº†ï¼ˆç±»å‹æ˜¯ Stringï¼‰</span>
</span></span></code></pre></div><p>å¦‚æœè¯´åœ¨ <a href=/swift-1.2/>Swift 1.2</a> ä¸­ä»‹ç»çš„å¹¶è¡Œ optional ç»‘å®šé¢†å¯¼äº†å¯¹ <a href=http://www.scottlogic.com/blog/2014/12/08/swift-optional-pyramids-of-doom.html>å„è¿é‡‘å­—å¡”</a> çš„é©å‘½ï¼Œé‚£ä¹ˆ <code>guard</code> å£°æ˜åˆ™ä¸ä¹‹ä¸€å¹¶å°†é‡‘å­—å¡”æ‘§æ¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>for</span> imageName <span style=color:#66d9ef>in</span> imageNamesList {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>guard</span> <span style=color:#66d9ef>let</span> image = UIImage(named: imageName)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> { <span style=color:#66d9ef>continue</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// do something with image</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ä½¿ç”¨-guard-æ¥é¿å…è¿‡å¤šçš„ç¼©è¿›å’Œé”™è¯¯>ä½¿ç”¨ guard æ¥é¿å…è¿‡å¤šçš„ç¼©è¿›å’Œé”™è¯¯</h3><p>æˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹ä½¿ç”¨ <code>guard</code> å…³é”®å­—ä¹‹åèƒ½å¦‚ä½•æ”¹å–„ä»£ç ä¸”å¸®åŠ©æˆ‘ä»¬é¿å…é”™è¯¯ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬è¦å®ç°ä¸€ä¸ª <code>readBedtimeStory()</code> å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>StoryError</span>: Error {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> missing
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> illegible
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> tooScary
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>readBedtimeStory</span>() <span style=color:#66d9ef>throws</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> url = Bundle.main.url(forResource: <span style=color:#e6db74>&#34;book&#34;</span>,
</span></span><span style=display:flex><span>                               withExtension: <span style=color:#e6db74>&#34;txt&#34;</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> data = <span style=color:#66d9ef>try</span>? Data(contentsOf: url),
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> story = String(data: data, encoding: .utf8)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> story.contains(<span style=color:#e6db74>&#34;ğŸ‘¹&#34;</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> StoryError.tooScary
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#34;Once upon a time... </span><span style=color:#e6db74>\(</span>story<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> StoryError.illegible
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> StoryError.missing
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¦è¯»ä¸€ä¸ªç¡å‰æ•…äº‹ï¼Œæˆ‘ä»¬éœ€è¦èƒ½æ‰¾åˆ°ä¸€æœ¬ä¹¦ï¼Œè¿™æœ¬æ•…äº‹ä¹¦å¿…é¡»è¦æ˜¯å¯è¯»çš„ï¼Œå¹¶ä¸”æ•…äº‹ä¸èƒ½å¤ªå“äººï¼ˆ<strong>è¯·ä¸è¦è®©æ€ªç‰©å‡ºç°åœ¨ä¹¦çš„ç»“å°¾ï¼Œè°¢è°¢ä½ ï¼</strong>ï¼‰ã€‚</p><p>è¯·æ³¨æ„ <code>throw</code> è¯­å¥ç¦»æ£€æŸ¥æœ¬èº«æœ‰å¤šè¿œã€‚ä½ éœ€è¦è¯»å®Œæ•´ä¸ªæ–¹æ³•æ¥æ‰¾åˆ°å¦‚æœæ²¡æœ‰ <code>book.txt</code> ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p><p>åƒä¸€æœ¬å¥½ä¹¦ä¸€æ ·ï¼Œä»£ç åº”è¯¥è®²è¿°ä¸€ä¸ªæ•…äº‹ï¼šæœ‰ç€æ˜“æ‡‚çš„æƒ…èŠ‚ï¼Œæ¸…æ™°çš„å¼€ç«¯ã€å‘å±•å’Œç»“å°¾ã€‚ï¼ˆè¯·å°è¯•ä¸è¦å†™å¤ªå¤šã€Œåç°ä»£ã€é£æ ¼çš„ä»£ç ã€‚ï¼‰</p><p>ä½¿ç”¨ <code>guard</code> è¯­å¥ç»„ç»‡ä»£ç å¯ä»¥è®©ä»£ç è¯»èµ·æ¥æ›´åŠ çš„çº¿æ€§ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>readBedtimeStory</span>() <span style=color:#66d9ef>throws</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>guard</span> <span style=color:#66d9ef>let</span> url = Bundle.main.url(forResource: <span style=color:#e6db74>&#34;book&#34;</span>,
</span></span><span style=display:flex><span>                                  withExtension: <span style=color:#e6db74>&#34;txt&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> StoryError.missing
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>guard</span> <span style=color:#66d9ef>let</span> data = <span style=color:#66d9ef>try</span>? Data(contentsOf: url),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> story = String(data: data, encoding: .utf8)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> StoryError.illegible
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> story.contains(<span style=color:#e6db74>&#34;ğŸ‘¹&#34;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> StoryError.tooScary
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Once upon a time ...</span><span style=color:#e6db74>\(</span>story<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>è¿™æ ·å°±å¥½å¤šäº†ï¼</strong> æ¯ä¸€ä¸ªé”™è¯¯éƒ½åœ¨ç›¸åº”çš„æ£€æŸ¥ä¹‹åç«‹åˆ»è¢«æŠ›å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å·¦æ‰‹è¾¹çš„ä»£ç é¡ºåºæ¥æ¢³ç†å·¥ä½œæµçš„é¡ºåºã€‚</p><h3 id=ä¸è¦åœ¨-guard-ä¸­åŒé‡å¦å®š>ä¸è¦åœ¨ guard ä¸­åŒé‡å¦å®š</h3><p>ä¸è¦æ»¥ç”¨è¿™ä¸ªæ–°çš„æµç¨‹æ§åˆ¶æœºåˆ¶â€”â€”ç‰¹åˆ«æ˜¯åœ¨æ¡ä»¶è¡¨è¾¾å¼å·²ç»è¡¨ç¤ºå¦å®šçš„æƒ…å†µä¸‹ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æƒ³è¦åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸ºç©ºæ˜¯ææ—©é€€å‡ºï¼Œä¸è¦è¿™æ ·å†™ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// å•Šï¼Ÿ</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>guard</span> <span style=color:#f92672>!</span>string.isEmpty <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¿æŒç®€å•ã€‚è‡ªç„¶çš„èµ°ä¸‹å»ã€‚é¿å…åŒé‡å¦å®šã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// å™¢ï¼</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> string.isEmtpy {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=defer>defer</h2><p>åœ¨é”™è¯¯å¤„ç†æ–¹é¢ï¼Œ<code>guard</code> å’Œæ–°çš„ <code>throw</code> è¯­æ³•ä¹‹é—´ï¼ŒSwift é¼“åŠ±ç”¨å°½æ—©è¿”å›é”™è¯¯ï¼ˆè¿™ä¹Ÿæ˜¯ NSHipster æœ€å–œæ¬¢çš„æ–¹å¼ï¼‰æ¥ä»£æ›¿åµŒå¥— if çš„å¤„ç†æ–¹å¼ã€‚å°½æ—©è¿”å›è®©å¤„ç†æ›´æ¸…æ™°äº†ï¼Œä½†æ˜¯å·²ç»è¢«åˆå§‹åŒ–ï¼ˆå¯èƒ½ä¹Ÿæ­£åœ¨è¢«ä½¿ç”¨ï¼‰çš„èµ„æºå¿…é¡»åœ¨è¿”å›å‰è¢«å¤„ç†å¹²å‡€ã€‚</p><p><code>defer</code> å…³é”®å­—ä¸ºæ­¤æä¾›äº†å®‰å…¨åˆç®€å•çš„å¤„ç†æ–¹å¼ï¼šå£°æ˜ä¸€ä¸ª blockï¼Œå½“å‰ä»£ç æ‰§è¡Œçš„é—­åŒ…é€€å‡ºæ—¶ä¼šæ‰§è¡Œè¯¥ blockã€‚</p><p>çœ‹çœ‹ä¸‹é¢è¿™ä¸ªåŒ…è£…äº†ç³»ç»Ÿè°ƒç”¨ <code>gethostname(2)</code> çš„å‡½æ•°ï¼Œç”¨æ¥è¿”å›å½“å‰ç³»ç»Ÿçš„<a href=https://zh.wikipedia.org/zh-cn/%E4%B8%BB%E6%A9%9F%E5%90%8D%E7%A8%B1>ä¸»æœºåç§°</a>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Darwin</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>currentHostName</span>() -&gt; String {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> capacity = Int(NI_MAXHOST)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer = UnsafeMutablePointer&lt;Int8&gt;.allocate(capacity: capacity)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>guard</span> gethostname(buffer, capacity) == <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        buffer.deallocate()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> hostname = String(cString: buffer)
</span></span><span style=display:flex><span>    buffer.deallocate()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hostname
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™é‡Œæœ‰ä¸€ä¸ªåœ¨æœ€å¼€å§‹å°±åˆ›å»ºçš„ <code>UnsafeMutablePointer&lt;UInt8></code> ç”¨äºå­˜å‚¨ç›®æ ‡æ•°æ®ï¼Œä½†æ˜¯æˆ‘<strong>æ—¢è¦</strong>åœ¨é”™è¯¯å‘ç”Ÿåé”€æ¯å®ƒï¼Œ<strong>åˆè¦</strong>åœ¨æ­£å¸¸æµç¨‹ä¸‹ä¸å†ä½¿ç”¨å®ƒæ—¶å¯¹å…¶è¿›è¡Œé”€æ¯ã€‚</p><p>è¿™ç§è®¾è®¡å¾ˆå®¹æ˜“å¯¼è‡´é”™è¯¯ï¼Œè€Œä¸”ä¸åœåœ°åœ¨åšé‡å¤å·¥ä½œã€‚</p><p>é€šè¿‡ä½¿ç”¨ <code>defer</code> è¯­å¥ï¼Œæˆ‘ä»¬å¯ä»¥æ’é™¤æ½œåœ¨çš„é”™è¯¯å¹¶ä¸”ç®€åŒ–ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>currentHostName</span>() -&gt; String {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> capacity = Int(NI_MAXHOST)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> buffer = UnsafeMutablePointer&lt;Int8&gt;.allocate(capacity: capacity)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> { buffer.deallocate() }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>guard</span> gethostname(buffer, capacity) == <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> String(cString: buffer)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å°½ç®¡ <code>defer</code> ç´§æ¥ç€å‡ºç°åœ¨ <code>allocate(capacity:)</code> è°ƒç”¨ä¹‹åï¼Œä½†å®ƒè¦ç­‰åˆ°å½“å‰åŒºåŸŸç»“æŸæ—¶æ‰ä¼šè¢«æ‰§è¡Œã€‚å¤šäºäº† <code>defer</code>ï¼Œ<code>buffer</code> æ‰èƒ½æ— è®ºåœ¨å“ªä¸ªç‚¹é€€å‡ºå‡½æ•°éƒ½å¯ä»¥è¢«é‡Šæ”¾ã€‚</p><p>è€ƒè™‘åœ¨ä»»ä½•éœ€è¦é…å¯¹è°ƒç”¨çš„ API ä¸Šéƒ½ä½¿ç”¨ <code>defer</code>ï¼Œæ¯”å¦‚ <code>allocate(capacity:)</code> / <code>deallocate()</code>ã€<code>wait()</code> / <code>signal()</code> å’Œ <code>open()</code> / <code>close()</code>ã€‚è¿™æ ·çš„è¯ï¼Œä½ ä¸ä»…å¯ä»¥æ¶ˆé™¤ä¸€ç§ç¨‹åºå‘˜æ˜“çŠ¯çš„é”™è¯¯ï¼Œè¿˜èƒ½è®© Dijkstra è‡ªè±ªåœ°ç”¨å®ƒçš„æ¯è¯­å¾·è¯­è¯´ï¼šã€ŒGoed gedaan!ã€ã€‚</p><h3 id=ç»å¸¸-defer>ç»å¸¸ defer</h3><p>å¦‚æœåœ¨åŒä¸€ä¸ªä½œç”¨åŸŸå†…ä½¿ç”¨å¤šä¸ª <code>defer</code> è¯­å¥ï¼Œå®ƒä»¬ä¼šæ ¹æ®å‡ºç°é¡ºåºåè¿‡æ¥æ‰§è¡Œâ€”â€”åƒæ ˆä¸€æ ·ã€‚è¿™ä¸ªååºæ˜¯éå¸¸é‡è¦çš„ç»†èŠ‚ï¼Œä¿è¯äº†è¢«å»¶è¿Ÿçš„ä»£ç å—åˆ›å»ºæ—¶ä½œç”¨åŸŸå†…å­˜åœ¨çš„ä¸œè¥¿ï¼Œåœ¨ä»£ç å—æ‰§è¡ŒåŒæ ·å­˜åœ¨ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ‰§è¡Œè¿™æ®µä»£ç ä¼šå¾—åˆ°ä¸‹é¢çš„è¾“å‡ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>procrastinate</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> { print(<span style=color:#e6db74>&#34;wash the dishes&#34;</span>) }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> { print(<span style=color:#e6db74>&#34;take out the recycling&#34;</span>) }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> { print(<span style=color:#e6db74>&#34;clean the refrigerator&#34;</span>) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;play videogames&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><samp>play videogames<br>clean the refrigerator<br>take out the recycling<br>wash the dishes<br></samp><blockquote><p>å¦‚æœä½ åƒè¿™æ ·åµŒå¥— <code>defer</code> è¯­å¥ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿ</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>defer</span> { <span style=color:#66d9ef>defer</span> { print(<span style=color:#e6db74>&#34;clean the gutter&#34;</span>) } }
</span></span></code></pre></div><blockquote><p>ä½ çš„ç¬¬ä¸€æƒ³æ³•å¯èƒ½æ˜¯è¯­å¥ä¼šè¢«å‹å…¥æ ˆçš„æœ€åº•éƒ¨ã€‚ä½†å¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚ä»”ç»†æƒ³ä¸€æƒ³ï¼Œç„¶ååœ¨ Playground é‡ŒéªŒè¯ä½ çš„çŒœæƒ³ã€‚</p></blockquote><h3 id=æ­£ç¡®-defer>æ­£ç¡® defer</h3><p>å¦‚æœåœ¨ <code>defer</code> è¯­å¥ä¸­å¼•ç”¨äº†ä¸€ä¸ªå˜é‡ï¼Œæ‰§è¡Œæ—¶ä¼šç”¨åˆ°å˜é‡æœ€ç»ˆçš„å€¼ã€‚æ¢å¥è¯è¯´ï¼š<code>defer</code> ä»£ç å—ä¸ä¼šæ•è·å˜é‡å½“å‰çš„å€¼ã€‚</p><p>å¦‚æœä½ è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¼šå¾—åˆ°ä¸‹é¢çš„è¾“å‡ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>flipFlop</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> position = <span style=color:#e6db74>&#34;It&#39;s pronounced /É¡Éªf/&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> { print(position) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    position = <span style=color:#e6db74>&#34;It&#39;s pronounced /dÊ’Éªf/&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> { print(position) }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><samp>It's pronounced /dÊ’Éªf/<br>It's pronounced /dÊ’Éªf/</samp><h3 id=ä»”ç»†-defer>ä»”ç»† defer</h3><p>å¦ä¸€ä»¶éœ€è¦æ³¨æ„çš„äº‹æƒ…ï¼Œé‚£å°±æ˜¯ <code>defer</code> ä»£ç å—æ— æ³•è·³å‡ºå®ƒæ‰€åœ¨çš„ä½œç”¨åŸŸã€‚å› æ­¤å¦‚ä½ å°è¯•è°ƒç”¨ä¸€ä¸ªä¼š throw çš„æ–¹æ³•ï¼ŒæŠ›å‡ºçš„é”™è¯¯å°±æ— æ³•ä¼ é€’åˆ°å…¶å‘¨å›´çš„ä¸Šä¸‹æ–‡ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>burnAfterReading</span>(file url: URL) <span style=color:#66d9ef>throws</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> { <span style=color:#66d9ef>try</span> FileManager.<span style=color:#66d9ef>default</span>.removeItem(at: url) }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ğŸ›‘ Errors not handled</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> string = <span style=color:#66d9ef>try</span> String(contentsOf: url)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä½œä¸ºæ›¿ä»£ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>try?</code> æ¥æ— è§†æ‰é”™è¯¯ï¼Œæˆ–è€…ç›´æ¥å°†è¯­å¥ç§»å‡º <code>defer</code> ä»£ç å—ï¼Œå°†å…¶æ”¾åˆ°å‡½æ•°çš„æœ€åï¼Œæ­£å¸¸çš„æ‰§è¡Œã€‚</p><h3 id=å…¶ä»–æƒ…å†µä¸‹defer-ä¼šå¸¦æ¥åå¤„>ï¼ˆå…¶ä»–æƒ…å†µä¸‹ï¼‰Defer ä¼šå¸¦æ¥åå¤„</h3><p>è™½ç„¶ <code>defer</code> åƒä¸€ä¸ªè¯­æ³•ç³–ä¸€æ ·ï¼Œä½†ä¹Ÿè¦å°å¿ƒä½¿ç”¨é¿å…å½¢æˆå®¹æ˜“è¯¯è§£ã€éš¾ä»¥é˜…è¯»çš„ä»£ç ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ä½ å¯èƒ½ä¼šå°è¯•ç”¨ <code>defer</code> æ¥å¯¹æŸäº›å€¼è¿”å›ä¹‹å‰åšæœ€åä¸€æ­¥çš„å¤„ç†ï¼Œä¾‹å¦‚è¯´åœ¨åç½®è¿ç®—ç¬¦ <code>++</code> çš„å®ç°ä¸­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>postfix</span> <span style=color:#66d9ef>func</span> <span style=color:#f92672>++</span>(<span style=color:#66d9ef>inout</span> x: Int) -&gt; Int {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> current = x
</span></span><span style=display:flex><span>    x <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> current
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ç”¨ <code>defer</code> æ¥è¿›è¡Œä¸€ä¸ªå¾ˆå¦ç±»çš„æ“ä½œã€‚å¦‚æœèƒ½åœ¨ defer ä¸­å¤„ç†çš„è¯ä¸ºä»€ä¹ˆè¦åˆ›å»ºä¸´æ—¶å˜é‡å‘¢ï¼Ÿ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>postfix</span> <span style=color:#66d9ef>func</span> <span style=color:#f92672>++</span>(<span style=color:#66d9ef>inout</span> x: Int) -&gt; Int {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> { x <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span> }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™ç§å†™æ³•ç¡®å®èªæ˜ï¼Œä½†è¿™æ ·å´é¢ å€’äº†å‡½æ•°çš„é€»è¾‘é¡ºåºï¼Œæå¤§é™ä½äº†ä»£ç çš„å¯è¯»æ€§ã€‚åº”è¯¥ä¸¥æ ¼éµå¾ª <code>defer</code> åœ¨æ•´ä¸ªç¨‹åºæœ€åè¿è¡Œä»¥é‡Šæ”¾å·²ç”³è¯·èµ„æºçš„åŸåˆ™ï¼Œå…¶ä»–ä»»ä½•ä½¿ç”¨æ–¹æ³•éƒ½å¯èƒ½è®©ä»£ç ä¹±æˆä¸€å›¢ã€‚</p><hr><p>ã€Œèªæ˜çš„ç¨‹åºå‘˜æ˜ç™½è‡ªå·±çš„å±€é™æ€§ã€ï¼Œæˆ‘ä»¬å¿…é¡»æƒè¡¡æ¯ç§è¯­è¨€ç‰¹æ€§çš„å¥½å¤„å’Œå…¶æˆæœ¬ã€‚</p><p>ç±»ä¼¼äº <code>guard</code> çš„æ–°ç‰¹æ€§èƒ½è®©ä»£ç æµç¨‹ä¸Šæ›´çº¿æ€§ï¼Œå¯è¯»æ€§æ›´é«˜ï¼Œå°±åº”è¯¥å°½å¯èƒ½ä½¿ç”¨ã€‚</p><p>åŒæ · <code>defer</code> ä¹Ÿè§£å†³äº†é‡è¦çš„é—®é¢˜ï¼Œä½†æ˜¯ä¼šå¼ºè¿«æˆ‘ä»¬ä¸€å®šè¦æ‰¾åˆ°å®ƒå£°æ˜çš„åœ°æ–¹æ‰èƒ½è¿½è¸ªåˆ°å…¶é”€æ¯çš„æ–¹æ³•ï¼Œå› ä¸ºå£°æ˜æ–¹æ³•å¾ˆå®¹æ˜“è¢«æ»šåŠ¨å‡ºäº†è§†é‡ä¹‹å¤–ï¼Œæ‰€ä»¥åº”è¯¥å°½å¯èƒ½éµå¾ªå®ƒå‡ºç°çš„åˆè¡·å°½å¯èƒ½å°‘åœ°ä½¿ç”¨ï¼Œé¿å…é€ æˆæ··æ·†å’Œæ™¦æ¶©ã€‚</p><hr><p>é™¤é<a href=https://nshipster.cn/ target=_blank>å¦æœ‰å£°æ˜</a>ï¼Œæœ¬æ–‡é‡‡ç”¨çŸ¥è¯†å…±äº«ã€Œ<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>ç½²å-éå•†ä¸šæ€§ä½¿ç”¨ 3.0 ä¸­å›½å¤§é™†</a>ã€è®¸å¯åè®®æˆæƒã€‚</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top Â· å›é¡¶éƒ¨" rel=nofollow>&#127772;2015-10-05 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2026 Mattt & Nate Cook ç‰ˆæƒæ‰€æœ‰</a><a href=https://autoptr.top/ title="Back to Home Â· å›é¦–é¡µ">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>æ ‡ç­¾:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>åˆ†ç±»:</span><li><a class=link href=https://autoptr.top/categories/Swift target=_blank>Swift</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>