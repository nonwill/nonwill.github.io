<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>NSExpression</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="NSExpression,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="NSExpression,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"🌜"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>NSExpression</span><span class=btRight><span title="Author · 作者" class=author>Mattt</span> <span title="Translator · 翻译" class=author>Zihan Xu</span> <a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post · 关联或转载引用的文章" target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics · 回主题页">&#127793;</a></span></h1><p>每当涉及查询或者整理信息时，Cocoa总是其他标准库羡慕的对象。通过使用<code>NSPredicate</code>，<a href=https://nshipster.com/nssortdescriptor/><code>NSSortDescriptor</code></a>，以及偶尔使用<code>NSFetchRequest</code>，即使是最复杂的数据任务也可以被简化成为几行_极其容易读懂_的代码。</p><p>现在，NSHipster们无疑已经熟悉<code>NSPredicate</code> 了（如果你还不熟悉，下周一定要过来看看），不过如果我们更进一步看看<code>NSPredicate</code>，我们会发现<code>NSPredicate</code>其实是由更小的部分而组成：两个<code>NSExpression</code>（一个左手值和一个右手值），和一个运算符相比较（比如<code>&lt;</code>，<code>IN</code>，<code>LIKE</code>等等）。</p><p>大多数开发者通过<code>+predicateWithFormat:</code>来使用<code>NSPredicate</code>，<code>NSExpression</code>是一个相对难懂的类。真可惜啊，因为<code>NSExpression</code>本身的功能非常强大。</p><p>所以，亲爱的读者，请允许我来表达我对<code>NSExpression</code>深深的尊重和着迷：</p><h2 id=评估数学>评估数学</h2><p>关于<code>NSExpression</code>你所要知道的第一件事就是它的主要目的是减少表达。如果你思考一下评估<code>NSPredicate</code>的过程，你会发现它有两个表达和一个比较符号，所以我们需要将两个表达简化为运算符可以处理的表达&ndash;非常像编译一行代码的过程。</p><p>这就是我们要学习的<code>NSExpression</code>的第一招： <strong>做数学题</strong>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>NSExpression <span style=color:#f92672>*</span>expression <span style=color:#f92672>=</span> [NSExpression expressionWithFormat:<span style=color:#e6db74>@&#34;4 + 5 - 2**3&#34;</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>id</span> value <span style=color:#f92672>=</span> [expression expressionValueWithObject:nil context:nil]; <span style=color:#75715e>// =&gt; 1
</span></span></span></code></pre></div><p>这并不是<a href="http://www.wolframalpha.com/input/?i=finn+the+human+like+curve">Wolfram Alpha</a>，但是如果加入评估数学表达式对于你的应用很有用的话，那么&mldr;你就可以使用NSExpression。</p><h2 id=函数>函数</h2><p>我们仅仅触及了<code>NSExpression</code>的表面。觉得一台电脑仅仅做小学数学不怎么厉害？那高中的统计学怎么样？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>NSArray <span style=color:#f92672>*</span>numbers <span style=color:#f92672>=</span> <span style=color:#ae81ff>@[</span><span style=color:#ae81ff>@1</span>, <span style=color:#ae81ff>@2</span>, <span style=color:#ae81ff>@3</span>, <span style=color:#ae81ff>@4</span>, <span style=color:#ae81ff>@4</span>, <span style=color:#ae81ff>@5</span>, <span style=color:#ae81ff>@9</span>, <span style=color:#ae81ff>@11</span><span style=color:#ae81ff>]</span>;
</span></span><span style=display:flex><span>NSExpression <span style=color:#f92672>*</span>expression <span style=color:#f92672>=</span> [NSExpression expressionForFunction:<span style=color:#e6db74>@&#34;stddev:&#34;</span> arguments:<span style=color:#ae81ff>@[</span>[NSExpression expressionForConstantValue:numbers]<span style=color:#ae81ff>]</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>id</span> value <span style=color:#f92672>=</span> [expression expressionValueWithObject:nil context:nil]; <span style=color:#75715e>// =&gt; 3.21859...
</span></span></span></code></pre></div><blockquote><p><code>NSExpression</code> 函数以给定数目的子表达式作为参数。比如，在上述例子中，要得到集合的标准差，数列中的数字要被<code>+expressionForConstantValue:</code>封装。虽然只是一个小小的不便（它最终却能使得<code>NSExpression</code>变得极其灵活），却足以使第一次尝试它的人绊倒。</p></blockquote><p>如果你觉得 <a href=https://nshipster.com/kvc-collection-operators/>键值编码简单集合运算符</a> （<code>@avg</code>，<code>@sum</code>等等）不够用，也许<code>NSExpression</code>的自带的统计，算术和位运算功能能激起你的兴趣。</p><blockquote><p><strong>要注意的是</strong>：<a href=https://developer.apple.com/library/ios/#documentation/cocoa/reference/foundation/Classes/NSExpression_Class/Reference/NSExpression.html>根据Apple的<code>NSExpression</code>文档中的表格</a>，很明显，OS X & iOS的功能可用性之间没有重叠。看起来最近的iOS版本的确支持如<code>stddev</code>之类的函数，但这些变化并没有显示在头文件或者文档里。如果你注意到任何变化，请以<a href=https://github.com/NSHipster/articles/pulls>pull request的形式</a>告诉我，不胜感激。</p></blockquote><h3 id=统计>统计</h3><ul><li><code>average:</code></li><li><code>sum:</code></li><li><code>count:</code></li><li><code>min:</code></li><li><code>max:</code></li><li><code>median:</code></li><li><code>mode:</code></li><li><code>stddev:</code></li></ul><h3 id=基本运算>基本运算</h3><p>这些函数需要用两个<code>NSExpression</code>对象来表达数字。</p><ul><li><code>add:to:</code></li><li><code>from:subtract:</code></li><li><code>multiply:by:</code></li><li><code>divide:by:</code></li><li><code>modulus:by:</code></li><li><code>abs:</code></li></ul><h3 id=高级运算>高级运算</h3><ul><li><code>sqrt:</code></li><li><code>log:</code></li><li><code>ln:</code></li><li><code>raise:toPower:</code></li><li><code>exp:</code></li></ul><h3 id=边界函数>边界函数</h3><ul><li><code>ceiling:</code> - <em>（不小于数组中的值的最小积分值）</em></li><li><code>trunc:</code> - <em>（最接近但不大于数组中的值的积分值）</em></li></ul><h3 id=与mathh函数类似的函数>与<code>math.h</code>函数类似的函数</h3><p><code>ceiling</code>非常容易和<code>ceil(3)</code>混淆。<code>ceiling</code>作用于数字数组，而<code>ceil(3)</code>作用于一个<code>double</code>值（且它并没对应的内置<code>NSExpression</code>函数）。<code>floor:</code>在这里的作用和<code>floor(3)</code>一样。</p><ul><li><code>floor:</code></li></ul><h3 id=随机函数>随机函数</h3><p>两个变量&ndash;一个带参数，一个不带参数。不带参数时，<code>random</code>返回<code>rand(3)</code>的等值，而<code>random:</code>则从<code>NSExpression</code>的数字数组中取任意元素。</p><ul><li><code>random</code></li><li><code>random:</code></li></ul><h3 id=二进制运算>二进制运算</h3><ul><li><code>bitwiseAnd:with:</code></li><li><code>bitwiseOr:with:</code></li><li><code>bitwiseXor:with:</code></li><li><code>leftshift:by:</code></li><li><code>rightshift:by:</code></li><li><code>onesComplement:</code></li></ul><h3 id=日期函数>日期函数</h3><ul><li><code>now</code></li></ul><h3 id=字符串函数>字符串函数</h3><ul><li><code>lowercase:</code></li><li><code>uppercase:</code></li></ul><h3 id=空操作>空操作</h3><ul><li><code>noindex:</code></li></ul><h2 id=自定义函数>自定义函数</h2><p>除了这些内置的函数，你也可以在<code>NSExpression</code>中调用自定义函数。<a href=http://funwithobjc.tumblr.com/post/2922267976/using-custom-functions-with-nsexpression>由Dave DeLong所撰写的这篇文章</a> 详述了这个过程。</p><p>首先，在类别中定义一个对应的函数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>NSNumber</span> (Factorial)
</span></span><span style=display:flex><span>- (NSNumber <span style=color:#f92672>*</span>)<span style=color:#a6e22e>factorial</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>@end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@implementation</span> <span style=color:#a6e22e>NSNumber</span> (Factorial)
</span></span><span style=display:flex><span>- (NSNumber <span style=color:#f92672>*</span>)<span style=color:#a6e22e>factorial</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>@(</span>tgamma([self doubleValue] <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)<span style=color:#ae81ff>)</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>@end</span>
</span></span></code></pre></div><p>然后，这样使用函数（<code>+expressionWithFormat:</code> 中的<code>FUNCTION()</code>宏是构造<code>-expressionForFunction:</code>等等的过程的简写。）:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>NSExpression <span style=color:#f92672>*</span>expression <span style=color:#f92672>=</span> [NSExpression expressionWithFormat:<span style=color:#e6db74>@&#34;FUNCTION(4.2, &#39;factorial&#39;)&#34;</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>id</span> value <span style=color:#f92672>=</span> [expression expressionValueWithObject:nil context:nil]; <span style=color:#75715e>// 32.578...
</span></span></span></code></pre></div><p>这样的优势在于， 通过直接调用<code>-factorial</code>，我们可以调用<code>NSPredicate</code>查询中的函数。比如，我们可以定义一个<code>location:withinRadius:</code>方法来轻松的查询用户当前位置附近的管理对象。</p><p>正如Dave在他的文章中所提到的那样，这些用例十分边缘化，但它们肯定可以成为你的保留节目中有趣的技巧。.</p><hr><p>下一周，我们将在刚刚学过的<code>NSExpression</code>的基础上继续探索<code>NSPredicate</code>和其它一切容易被忽视的内容。敬请期待！</p><hr><p>除非<a href=https://nshipster.cn/ target=_blank>另有声明</a>，本文采用知识共享「<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>署名-非商业性使用 3.0 中国大陆</a>」许可协议授权。</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top · 回顶部" rel=nofollow>&#127772;2013-07-08 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2025 Mattt 版权所有</a><a href=https://autoptr.top/ title="Back to Home · 回首页">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>标签:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>分类:</span><li><a class=link href=https://autoptr.top/categories/Cocoa target=_blank>Cocoa</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>