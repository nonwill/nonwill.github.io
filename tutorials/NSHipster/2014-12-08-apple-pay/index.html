<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>Apple Pay</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="Apple Pay,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="Apple Pay,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"🌜"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>Apple Pay</span><span class=btRight><span title="Author · 作者" class=author>Jack Flintermann</span> <span title="Translator · 翻译" class=author>Croath Liu</span> <a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post · 关联或转载引用的文章" target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics · 回主题页">&#127793;</a></span></h1><p><strong>注意：截止 2015 年 1 月，Apple Pay 仅在美国可用。</strong></p><p>你要在网上买东西的那一刻你会发现有一种现代化带来的独有的焦虑感。那种感觉不能用语言形容，大概是这样的：&ldquo;我的信用卡去哪了？卡号是多少？我好想买这个啊卡去哪了！&rdquo;</p><p>当你用 iOS 设备的时候，这种困难又加剧了一层：很有可能你的卡并不在身边，也有可能你会一手拿着信用卡另一手同时在手机上输入，这样的壮举最好还是留给体操运动员和宇航员吧。（开个玩笑，但我打赌苹果应该在某个实验室里面这样实验过了。）</p><p>如果你刚好在开发一款能够接受信用卡付款的应用，这种不幸的现象直接会导致你收入的减少。</p><p><a href=https://apple.com/apple-pay>Apple Pay</a> 改变了这一切。大多数人可能还在关注它发布时提到的在实体店的功用（消费者可以用 iPhone NFC 功能付款），与此同时这也为开发者提升在应用内付款体验的巨大机会。</p><blockquote><p>提示：如果你在应用内卖电子化商品或虚拟货币，那么应该用应用内支付而不是 Apple Pay。(请看 App Store Review Guidelines 的这一章 <a href=https://developer.apple.com/app-store/review/guidelines/#purchasing-currencies>section 11.2</a>)。Apple Pay 可以用来销售实体商品和服务。</p></blockquote><hr><h2 id=获取一个-apple-merchant-id>获取一个 Apple Merchant ID</h2><p>测试支付之前需要注册一个 Apple Merchant ID。还要先选择一个能够控制信用卡支付流程的服务提供商。苹果提供了一个这类提供商的推荐列表：<a href=https://developer.apple.com/apple-pay>Apple Pay Developer Page</a> (作者自曝就职于这个推荐列表中的 <a href=https://stripe.com/>Stripe</a> 公司，但本文涉及到的代码和选择什么服务提供商是无关的)。你的服务提供商会给你一份特别说明指导如何在他们的平台上使用 Apple Pay 来支付，整个流程类似于这样：</p><ul><li>前往 Apple Developer Center <code>Certificates, Identifiers, and Profiles</code> 部分 <a href=https://developer.apple.com/account/ios/identifiers/merchant/merchantCreate.action>创建一个 merchant ID</a>。</li><li>接下来，<a href=https://developer.apple.com/account/ios/certificate/certificateCreate.action>前往 Certificates 部分</a> 新建一个 Apple Pay Certificate。这步需要上传一个 Certificate Signing Request。注册服务提供商的时候他们会给你一个可用的 CSR 文件，你也可以用自己生成的 CSR 文件走完整个流程，但你的服务提供商不能用你生成的 CSR 来完成支付的解谜流程。</li><li>在 Xcode 里，在工程设置的 &ldquo;Capabilities&rdquo; 部分打开 &ldquo;Apple Pay&rdquo;。这步可能会要求你选择之前创建的 merchant ID。</li></ul><h2 id=拿到第一桶金>拿到第一桶金</h2><blockquote><p>Apple Pay 只能在部分 iOS 设备上工作(包括 iPhone6/6+、iPad Mini 3、iPad Air 2)。另外，测试时需要添加 Apple Pay entitlement(在“获取一个 Apple Merchant ID”章节中提到过)。如果想在模拟器中测试，可以用这个库来模拟支付功能(带有测试用的信用卡信息) <a href=https://github.com/stripe/ApplePayStubs>https://github.com/stripe/ApplePayStubs</a> 。</p></blockquote><p>一旦有了 merchant 账号，使用 Apple Pay 进行收款就近在咫尺了。接下来，需要先检查用户的设备十分支持 Apple Pay 以及用户可使用的信用卡种类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> paymentNetworks = [PKPaymentNetworkAmex, PKPaymentNetworkMasterCard, PKPaymentNetworkVisa]
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> PKPaymentAuthorizationViewController.canMakePaymentsUsingNetworks(paymentNetworks) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Pay is available!</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Show your own credit card form.</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>假设此时 Apple Pay 是可使用状态，下一步就是构建一个 <code>PKPaymentRequest</code>。这是一个描述用户扣款信息的对象。如果付款行为发生在美国(当然目前 Apple Pay 仅在美国可用)，还有其他一些你需要配置的常量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> request = PKPaymentRequest()
</span></span><span style=display:flex><span>request.supportedNetworks = [PKPaymentNetworkAmex, PKPaymentNetworkMasterCard, PKPaymentNetworkVisa]
</span></span><span style=display:flex><span>request.countryCode = <span style=color:#e6db74>&#34;US&#34;</span>
</span></span><span style=display:flex><span>request.currencyCode = <span style=color:#e6db74>&#34;USD&#34;</span>
</span></span><span style=display:flex><span>request.merchantIdentifier = <span style=color:#e6db74>&#34;&lt;#Replace me with your Apple Merchant ID#&gt;&#34;</span>
</span></span><span style=display:flex><span>request.merchantCapabilities = .Capability3DS
</span></span></code></pre></div><p>接下来，用 <code>paymentSummaryItems</code> 属性来描述消费者购买的商品。这个属性可以接受一个 <code>PKPaymentSummaryItem</code> 数组，<code>PKPaymentSummaryItem</code> 有 <code>label</code> 和 <code>amount</code> 两个属性。这些属性和收据(马上就能看到收据了)上显示的条目相关。</p><p><img alt="Payment Authorization" src=/media/NSHipster/apple-pay-payment-authorization.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> wax = PKPaymentSummaryItem(label: <span style=color:#e6db74>&#34;Mustache Wax&#34;</span>, amount: NSDecimalNumber(string: <span style=color:#e6db74>&#34;10.00&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> discount = PKPaymentSummaryItem(label: <span style=color:#e6db74>&#34;Discount&#34;</span>, amount: NSDecimalNumber(string: <span style=color:#e6db74>&#34;-1.00&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> totalAmount = wax.amount.decimalNumberByAdding(discount.amount)
</span></span><span style=display:flex><span>                            .decimalNumberByAdding(shipping.amount)
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> total = PKPaymentSummaryItem(label: <span style=color:#e6db74>&#34;NSHipster&#34;</span>, amount: totalAmount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>request.paymentSummaryItems = [wax, discount, shipping, total]
</span></span></code></pre></div><p>注意可以通过给条目价格赋予 0 值或负值来给消费者发放优惠或提示补充信息。然而一个收款的总金额必须大于 0。这里我们用一个 <code>PKShippingMethod</code>(继承自 <code>PKPaymentSummaryItem</code>)来描述我们发货的商品。之后会加以详述。</p><p>然后需要将付款单展示给消费者，通过 <code>PKPaymentRequest</code> 创建一个 <code>PKPaymentAuthorizationViewController</code> 然后 present 出来。(假设本样例中所有的代码都在一个置于付款页面后面的 <code>UIViewController</code> 中编写)。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> viewController = PKPaymentAuthorizationViewController(paymentRequest: request)
</span></span><span style=display:flex><span>viewController.delegate = <span style=color:#66d9ef>self</span>
</span></span><span style=display:flex><span>presentViewController(viewController, animated: <span style=color:#66d9ef>true</span>, completion: <span style=color:#66d9ef>nil</span>)
</span></span></code></pre></div><p>小提示：</p><ul><li>这个 View controller 没有占满屏幕 (这时看到的蓝色背景是我们应用中的一部分)。可以在 <code>PKPaymentAuthorizationViewController</code> 可见时随时更改背景色。</li><li>所有的文字信息都是自动大写的。</li><li>最后横线下的条目和其他的是分开的，这里用来表示总金额。文字会自动以 &ldquo;PAY&rdquo; 开头，所以这里用公司名字作为其 <code>label</code> 属性开起来会比较合理一些。</li><li>整套 UI 是通过一个 Remote View Controller present 出来的。这意味着除了传入的 <code>PKPaymentRequest</code> 之外是不能修改这个 view 的其他内容或样式的。</li></ul><h2 id=pkpaymentauthorizationviewcontrollerdelegate>PKPaymentAuthorizationViewControllerDelegate</h2><p>为了捕获 <code>PKPaymentAuthorizationViewController</code> 返回的付款信息需要实现 <code>PKPaymentAuthorizationViewControllerDelegate</code> 接口。它有两个必须实现的方法：<code>-(void)paymentAuthorizationViewController:didAuthorizePayment:completion:</code> 和 <code>-(void)paymentAuthorizationViewControllerDidFinish:</code>。</p><p>为了便于理解这些步骤都是如何工作的，我们来看一下 Apple Pay 付款的顺序流程：</p><ul><li>先像如上所述显示一个 <code>PKPaymentAuthorizationViewController</code>。</li><li>用户通过 Touch ID(如果三次失败之后需要通过密码来验证)授权支付。</li><li>指纹图案变成一个旋转的加载图案，并且显示 &ldquo;Processing&rdquo; 字样。</li><li>Delegate 收到 <code>paymentAuthorizationViewController:didAuthorizePayment:completion:</code> 回调。</li><li>应用同步地和付款服务商以及网站后端进行信息交换，根据付款详情进行扣款。完成之后，你要根据付款结果调用 <code>completion</code> 方法并传入 <code>PKPaymentAuthorizationStatus.Success</code> 或者 <code>PKPaymentAuthorizationStatus.Failure</code> 参数。</li><li><code>PKPaymentAuthorizationViewController</code> 的加载动画变成成功或者失败的图案。如果付款成功了，PassBook 会收到一个通知来对用户的信用卡进行扣款。</li><li>Delegate 收到 <code>paymentAuthorizationViewControllerDidFinish:</code> 回调，然后就可以调用 <code>dismissViewControllerAnimated:completion</code> 方法来关闭付款页面了。</li></ul><p><img alt="Status Indicator" src=/media/NSHipster/apple-pay-indicators.png></p><p>具体代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - PKPaymentAuthorizationViewControllerDelegate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>paymentAuthorizationViewController</span>(controller: PKPaymentAuthorizationViewController!, didAuthorizePayment payment: PKPayment!, completion: ((PKPaymentAuthorizationStatus) -&gt; Void)<span style=color:#f92672>!</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Use your payment processor&#39;s SDK to finish charging your customer.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// When this is done, call completion(PKPaymentAuthorizationStatus.Success)</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>paymentAuthorizationViewControllerDidFinish</span>(controller: PKPaymentAuthorizationViewController!) {
</span></span><span style=display:flex><span>    dismissViewControllerAnimated(<span style=color:#66d9ef>true</span>, completion: <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里的 <code>processPayment:payment completion:</code> 方法是在你自己代码中编写的，这个方法会让扣款服务商的 SDK 结束本次支付。</p><h2 id=动态显示物流信息和价格>动态显示物流信息和价格</h2><p>如果用户通过 Apple Pay 购买了实体商品，你可能需要需要提供给他们多种物流选项。这个可以在 <code>PKPaymentRequest</code> 的 <code>shippingMethods</code> 属性中设置。然后可以通过实现 <code>PKPaymentAuthorizationViewControllerDelegate</code> 中的 <code>paymentAuthorizationViewController:didSelectShippingMethod:completion:</code> 方法来对用户做出的选择进行反馈。这个方法遵循和 <code>didAuthorizePayment</code> 类似的方式，在这个方法里可以同步地做一些事情然后调用回调去更新包含用户付款信息的 <code>PKPaymentSummaryItem</code> 数组。(还记得吗我们之前提过由 <code>PKPaymentSummaryItem</code> 继承来的 <code>PKShippingMethod</code>，这东西能帮上大忙！)</p><p>此处对上面的代码做了一点小改动，实现了一个通过计算得出的物流属性：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>var</span> paymentRequest: PKPaymentRequest {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> request = ... <span style=color:#75715e>// initialize as before</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> freeShipping = PKShippingMethod(label: <span style=color:#e6db74>&#34;Free Shipping&#34;</span>, amount: NSDecimalNumber(string: <span style=color:#e6db74>&#34;0&#34;</span>))
</span></span><span style=display:flex><span>    freeShipping.identifier = <span style=color:#e6db74>&#34;freeshipping&#34;</span>
</span></span><span style=display:flex><span>    freeShipping.detail = <span style=color:#e6db74>&#34;Arrives in 6-8 weeks&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> expressShipping = PKShippingMethod(label: <span style=color:#e6db74>&#34;Express Shipping&#34;</span>, amount: NSDecimalNumber(string: <span style=color:#e6db74>&#34;10.00&#34;</span>))
</span></span><span style=display:flex><span>    expressShipping.identifier = <span style=color:#e6db74>&#34;expressshipping&#34;</span>
</span></span><span style=display:flex><span>    expressShipping.detail = <span style=color:#e6db74>&#34;Arrives in 2-3 days&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    request.shippingMethods = [freeShipping, expressShipping]
</span></span><span style=display:flex><span>    request.paymentSummaryItems = paymentSummaryItemsForShippingMethod(freeShipping)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> request
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>paymentSummaryItemsForShippingMethod</span>(shipping: PKShippingMethod) -&gt; ([PKPaymentSummaryItem]) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> wax = PKPaymentSummaryItem(label: <span style=color:#e6db74>&#34;Mustache Wax&#34;</span>, amount: NSDecimalNumber(string: <span style=color:#e6db74>&#34;10.00&#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> discount = PKPaymentSummaryItem(label: <span style=color:#e6db74>&#34;Discount&#34;</span>, amount: NSDecimalNumber(string: <span style=color:#e6db74>&#34;-1.00&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> totalAmount = wax.amount.decimalNumberByAdding(discount.amount)
</span></span><span style=display:flex><span>                                .decimalNumberByAdding(shipping.amount)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> total = PKPaymentSummaryItem(label: <span style=color:#e6db74>&#34;NSHipster&#34;</span>, amount: totalAmount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [wax, discount, shipping, total]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - PKPaymentAuthorizationViewControllerDelegate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>paymentAuthorizationViewController</span>(controller: PKPaymentAuthorizationViewController!, didSelectShippingMethod shippingMethod: PKShippingMethod!, completion: ((PKPaymentAuthorizationStatus, [AnyObject]<span style=color:#f92672>!</span>) -&gt; Void)<span style=color:#f92672>!</span>) {
</span></span><span style=display:flex><span>    completion(PKPaymentAuthorizationStatus.Success, paymentSummaryItemsForShippingMethod(shippingMethod))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在这个样例中，用户可以选择包邮和 express 发货两种选项，两种方法的费用会根据用户的选择自动调整。</p><p><em>别急，还有更多的东西呢</em></p><p>相对于提供一堆统一费率的物流选项，其实你可以让消费者选择运送地址然后动态计算物流费用。这需要设置 <code>PKPaymentRequest</code> 的 <code>requiredShippingAddressFields</code> 属性。这个属性含有 <code>PKAddressField.Email</code>、<code>PhoneNumber</code>、<code>PostalAddress</code> 信息。</p><blockquote><p>如果你不需要用户的具体运送地址但是需要一些联系方式(比如说需要寄送电子发票的邮箱)，也可以通过这个方式来实现。</p></blockquote><p>当设置了这个属性时，新的 &ldquo;Shipping Address&rdquo; 就会显示在付款的 UI 界面上，用户可以依次选择他们保存过的寄送地址。每当用户选择一个地址时，<code>PKPaymentAuthorizationViewControllerDelegate</code> 中的 <code>paymentAuthorizationViewController:didSelectShippingAddress:completion:</code>(顾名思义)方法就会调用。</p><p>此时你应当通过用户选择的地址信息计算出物流费用，之后调用 <code>completion</code> 回调并携带 3 个参数：</p><ol><li>调用结果<ul><li><code>PKPaymentAuthorizationStatus.Success</code> 代表成功</li><li><code>.Failure</code> 代表网络连接出错</li><li><code>.InvalidShippingPostalAddress</code> 代表 API 返回了一个空数组(例如填入了一个不可送达的地址)</li></ul></li><li>用 <code>PKShippingMethod</code> 类型的数组表示用户的可用物流选项</li><li>含有物流信息的新 <code>PKPaymentSummaryItem</code> 数组</li></ol><p>我写了一个使用 EasyPost API 通过地址能够查询邮费的简单 web 后台。源码见 <a href=https://github.com/jflinter/example-shipping-api>https://github.com/jflinter/example-shipping-api</a> 。</p><p>这里有一个使用 <a href=https://nshipster.com/alamofire/>Alamofire</a> 查询的样例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>AddressBook</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>PassKit</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Alamofire</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>addressesForRecord</span>(record: ABRecord) -&gt; [[String: String]] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> addresses: [[String: String]] = []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> values: ABMultiValue = ABRecordCopyValue(record, kABPersonAddressProperty).takeRetainedValue()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> index <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0.</span>.&lt;ABMultiValueGetCount(values) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> address = ABMultiValueCopyValueAtIndex(values, index).takeRetainedValue() <span style=color:#66d9ef>as</span>? [String: String] {
</span></span><span style=display:flex><span>            addresses.append(address)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> addresses
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>fetchShippingMethodsForAddress</span>(address: [String: String], completion: ([PKShippingMethod]?) -&gt; Void) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> parameters = [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;street&#34;</span>: address[kABPersonAddressStreetKey] ?? <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;city&#34;</span>: address[kABPersonAddressCityKey] ?? <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;state&#34;</span>: address[kABPersonAddressStateKey] ?? <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;zip&#34;</span>: address[kABPersonAddressZIPKey] ?? <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;country&#34;</span>: address[kABPersonAddressCountryKey] ?? <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Alamofire.request(.GET, <span style=color:#e6db74>&#34;http://example.com&#34;</span>, parameters: parameters)
</span></span><span style=display:flex><span>             .responseJSON { (<span style=color:#66d9ef>_</span>, <span style=color:#66d9ef>_</span>, JSON, <span style=color:#66d9ef>_</span>) <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> rates = JSON <span style=color:#66d9ef>as</span>? [[String: String]] {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>let</span> shippingMethods = map(rates) { (rate) -&gt; PKShippingMethod <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> identifier = rate[<span style=color:#e6db74>&#34;id&#34;</span>]
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> carrier = rate[<span style=color:#e6db74>&#34;carrier&#34;</span>] ?? <span style=color:#e6db74>&#34;Unknown Carrier&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> service = rate[<span style=color:#e6db74>&#34;service&#34;</span>] ?? <span style=color:#e6db74>&#34;Unknown Service&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> amount = NSDecimalNumber(string: rate[<span style=color:#e6db74>&#34;amount&#34;</span>])
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> arrival = rate[<span style=color:#e6db74>&#34;formatted_arrival_date&#34;</span>] ?? <span style=color:#e6db74>&#34;Unknown Arrival&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>let</span> shippingMethod = PKShippingMethod(label: <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>\(</span>carrier<span style=color:#e6db74>)</span><span style=color:#e6db74> </span><span style=color:#e6db74>\(</span>service<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>, amount: amount)
</span></span><span style=display:flex><span>                        shippingMethod.identifier = identifier
</span></span><span style=display:flex><span>                        shippingMethod.detail = arrival
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> shippingMethod
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>通过这种方法，可用简单地实现 <code>PKPaymentAuthorizationViewControllerDelegate</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>paymentAuthorizationViewController</span>(controller: PKPaymentAuthorizationViewController!, didSelectShippingAddress record: ABRecord!, completion: ((PKPaymentAuthorizationStatus, [AnyObject]<span style=color:#f92672>!</span>, [AnyObject]<span style=color:#f92672>!</span>) -&gt; Void)<span style=color:#f92672>!</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> address = addressesForRecord(record).first {
</span></span><span style=display:flex><span>        fetchShippingMethodsForAddress(address) { (shippingMethods) <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> shippingMethods?.count {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> .None:
</span></span><span style=display:flex><span>                completion(PKPaymentAuthorizationStatus.Failure, <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> .Some(<span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>                completion(PKPaymentAuthorizationStatus.InvalidShippingPostalAddress, <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                completion(PKPaymentAuthorizationStatus.Success, shippingMethods, <span style=color:#66d9ef>self</span>.paymentSummaryItemsForShippingMethod(shippingMethods!.first!))
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        completion(PKPaymentAuthorizationStatus.Failure, <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img alt="Select a Shipping Method" src=/media/NSHipster/apple-pay-select-shipping-method.png></p><p>至此，用户可以选择寄送地址以及基于其居住地得到的可用物流方式。用户最终选择的 <code>shippingAddress</code> 和 <code>shippingMethod</code> 会成为回调到 delegate 方法 <code>paymentAuthorizationViewController:didAuthorizePayment:completion:</code> 中 <code>PKPayment</code> 对象的某些属性。</p><blockquote><p>文中提到的所有源码可以在这个项目中找到：https://github.com/jflinter/ApplePayExample</p></blockquote><hr><p>虽然 Apple Pay 只开放了很少的 API，但<a href="https://itunes.apple.com/WebObjects/MZStore.woa/wa/viewFeature?id=927678292&mt=8&ls=1">很多</a> 应用还是借此实现了多种多样的功能，你可以通过定制化应用到自己的应用中。其实它开启了一个购买的新篇章，比如说，用户根本不用先注册就可以买东西。</p><p>随着越来越多的应用开始使用 Apple Pay(也随着越来越多的用户拥有支持 Apple Pay 的设备)，很快这就会成为 iOS 应用中普遍存在的支付方式。我很乐意看一看你们都如何用 Apple Pay 来丰富的你的产品 - 如果你有任何问题，或者想向我展示你的成果，请<a href=mailto:jack+nshipster@stripe.com>联系我</a>！</p><hr><p>除非<a href=https://nshipster.cn/ target=_blank>另有声明</a>，本文采用知识共享「<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>署名-非商业性使用 3.0 中国大陆</a>」许可协议授权。</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top · 回顶部" rel=nofollow>&#127772;2014-12-08 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2025 Jack Flintermann 版权所有</a><a href=https://autoptr.top/ title="Back to Home · 回首页">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>标签:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>分类:</span><li><a class=link href=https://autoptr.top/categories/Miscellaneous target=_blank>Miscellaneous</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>