<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>CFBag</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="CFBag,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="CFBag,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"🌜"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>CFBag</span><span class=btRight><span title="Author · 作者" class=author>Mattt</span> <span title="Translator · 翻译" class=author>Croath Liu</span> <a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post · 关联或转载引用的文章" target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics · 回主题页">&#127793;</a></span></h1><p>Objective-C被夹在了两个世界中间。</p><p>在其中一边的世界里，Objective-C遵循着经过深思熟虑的、发扬自[Smalltalk]的面向对象哲学理念，这种理念给我们带来了消息传递和参数命名法等好点子。另一边的世界里则避免不了有很多<a href=https://en.wikipedia.org/wiki/C_(programming_language)>C</a>的残留思想带来强大的力量和一坨混乱。</p><p>越来越多<code>@</code>符号的使用证明了这个一致性危机。</p><p>Foundation和Core Foundation的关系里也可以发现这种一致性问题，特别是那一堆无缝连接的类： <code>NSArray</code> / <code>CFArray</code>, <code>NSDictionary</code> / <code>CFDictionary</code>, <code>NSSet</code> / <code>CFSet</code>。这些类可以通过C函数和Objective-C方法传入传出而不需要手动转换。这是抽象化设计的缺陷，但是同时也是写应用时最实用的优化最难以优化部分的绝佳手段。</p><p>但是这种无缝连接是Foundation和Core Foundation之间集合类型转换的一个例外：</p><table><thead><tr><th>Foundation</th><th>Core Foundation</th><th>无缝转换</th></tr></thead><tbody><tr><td><tt>NSArray</tt><sup>*</sup></td><td><tt>CFArray</tt><sup>*</sup></td><td>✓</td></tr><tr><td><tt>NSCountedSet</tt></td><td><tt>CFBag</tt><sup>*</sup></td><td></td></tr><tr><td><em>N/A</em></td><td><tt>CFBinaryHeap</tt></td><td></td></tr><tr><td><em>N/A</em></td><td><tt>CFBitVector</tt><sup>*</sup></td><td></td></tr><tr><td><tt>NSDictionary</tt><sup>*</sup></td><td><tt>CFDictionary</tt><sup>*</sup></td><td>✓</td></tr><tr><td><tt>NSIndexSet</tt><sup>*</sup></td><td><em>N/A</em></td><td></td></tr><tr><td><tt>NSMapTable</tt></td><td><em>N/A</em></td><td></td></tr><tr><td><tt>NSOrderedSet</tt></td><td><em>N/A</em></td><td></td></tr><tr><td><tt>NSPointerArray</tt></td><td><em>N/A</em></td><td></td></tr><tr><td><tt>NSPointerFunctions</tt></td><td><em>N/A</em></td><td></td></tr><tr><td><tt>NSSet</tt><sup>*</sup></td><td><tt>CFSet</tt><sup>*</sup></td><td>✓</td></tr></tbody><tfoot><tr><td colspan=3><sup>*</sup> 代表同样适用于相应的mutable类型</td></tr></tfoot></table><p>看表格的第二行， <code>NSCountedSet</code> 和 <code>CFBag</code>。注意：不像Foundation和Core Foundation中的其他类型，他们之间不能无缝转换。相关文档中除了提供了 <code>NSCountedSet</code> 的一些简略信息，没有其他实在的内容能解释存在这样的类型转换方式。。我猜是因为 <code>NSCountedSet</code> 没有对应的可变(mutable)类型，于是这就打破了类似 <code>NSArray</code> 那些支持无缝转换的固有模式。</p><h2 id=bag一种抽象数据类型>Bag，一种抽象数据类型</h2><p>在计算机科学领域<a href=https://en.wikipedia.org/wiki/Collection_(abstract_data_type)>集合数据类型的殿堂</a>中，bag没有数组、集合、联合数组、树、图、优先队列那么占有一席之地。</p><p>其实bag本身就很晦涩，你可能从没听过这东西。</p><p>Bag，或者叫做<a href=https://en.wikipedia.org/wiki/Multiset>multiset</a>，是set的一种变体，不同的是bag里同一数据可以出现不止一次。集合中每一个唯一元素会有一个合计数字与其绑定。类似set一样，bag也是顺序不敏感的。</p><p>用bag的场景有&mldr;咳咳&mldr;很少，但有如果它出现你肯定能感觉到那就是bag。大选中统计票数？模拟家庭作业中的概率分布？实现一个Yahtzee骰子游戏？Bag都是你的新选择！</p><h2 id=使用cfmutablebag>使用<code>CFMutableBag</code></h2><p><code>CFBag</code> 和它的可变类型同类 <code>CFMutableBag</code> 作为bag类型的具体实现，都是非常灵活的。</p><p>虽然它们没有像 <code>NSCountedSet</code> 那样方便地面向对象化，但它可以进行的自定义行为却是多种多样的。你可以用带有许多回调的初始化函数来建立一个 <code>CFBag</code> ，这些回调函数定义在 <code>CFBagCallBacks</code> 结构中，该结构详细描述了一个值被插入、删除、比较的方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#66d9ef>struct</span> CFBagCallBacks {
</span></span><span style=display:flex><span>   CFIndex version;
</span></span><span style=display:flex><span>   CFBagRetainCallBack <span style=color:#66d9ef>retain</span>;
</span></span><span style=display:flex><span>   CFBagReleaseCallBack <span style=color:#66d9ef>release</span>;
</span></span><span style=display:flex><span>   CFBagCopyDescriptionCallBack copyDescription;
</span></span><span style=display:flex><span>   CFBagEqualCallBack equal;
</span></span><span style=display:flex><span>   CFBagHashCallBack hash;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> CFBagCallBacks CFBagCallBacks;
</span></span></code></pre></div><ul><li><code>retain</code>: 当一个值被添加到集合里时用于retain它的回调</li><li><code>release</code>: 当一个值被从集合里删除时用于release它的回调</li><li><code>copyDescription</code>: 用于集合中每个值建立一个string类型的description的回调</li><li><code>equal</code>: 用于比较集合中两个值是否相等的回调</li><li><code>hash</code>: 集合中用于计算值的Hash的回调</li></ul><p>例如，如果你正在做一个投票统计应用，你可以制定一个用于 <code>retain</code> 回调函数来保证不同大小写和错误拼写的名字能够归类到正确的候选人；也可以用 <code>equal</code> 回调函数来保证当所有选票都统计完时能够计算出票最多的候选人。</p><p><code>CFMutableBag</code> 也有 <code>CFBagApplyFunction</code>，这个函数可以用来改变集合中的值，比如说理顺选举数量之类的。</p><p>总而言之，如果你要准备搞一个选举， <code>CFBag</code> 是你的最佳选择。</p><hr><p>严肃地讲， <code>CFBag</code> 在它擅长的领域内确实好用，它时刻提醒着你这是标准框架和标准库中的一块隐藏的宝石，而发觉隐藏的宝藏，就是成为一个NSHipster的核心。</p><p>同样的，<code>CFBinaryHeap</code> 呢？ <code>NSPointerFunctions</code> 呢？ <code>NSMapTable</code> 呢？别急，以后我们都会谈到的。</p><hr><p>除非<a href=https://nshipster.cn/ target=_blank>另有声明</a>，本文采用知识共享「<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>署名-非商业性使用 3.0 中国大陆</a>」许可协议授权。</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top · 回顶部" rel=nofollow>&#127772;2012-08-27 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2025 Mattt 版权所有</a><a href=https://autoptr.top/ title="Back to Home · 回首页">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>标签:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>分类:</span><li><a class=link href=https://autoptr.top/categories/Cocoa target=_blank>Cocoa</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>