<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>Swift & the Objective-C Runtime</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="Swift & the Objective-C Runtime,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="Swift & the Objective-C Runtime,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"ğŸŒœ"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>Swift & the Objective-C Runtime</span><span class=btRight><span title="Author Â· ä½œè€…" class=author>Nate Cook</span> <span title="Translator Â· ç¿»è¯‘" class=author>Croath Liu</span> <a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post Â· å…³è”æˆ–è½¬è½½å¼•ç”¨çš„æ–‡ç« " target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics Â· å›ä¸»é¢˜é¡µ">&#127793;</a></span></h1><p>å³ä½¿ä¸€è¡Œ Objective-C ä»£ç ä¹Ÿä¸å†™ï¼Œæ¯ä¸€ä¸ª Swift app éƒ½ä¼šåœ¨ Objective-C runtime ä¸­è¿è¡Œï¼Œå¼€å¯åŠ¨æ€ä»»åŠ¡åˆ†å‘å’Œè¿è¡Œæ—¶å¯¹è±¡å…³è”çš„ä¸–ç•Œã€‚æ›´ç¡®åˆ‡åœ°è¯´ï¼Œå¯èƒ½åœ¨ä»…ä½¿ç”¨ Swift åº“çš„æ—¶å€™åªè¿è¡Œ Swift runtimeã€‚ä½† Objective-C runtime ä¸æˆ‘ä»¬å…±å¤„äº†å¦‚æ­¤é•¿çš„æ—¶é—´ï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥å°†å…¶å‘æŒ¥åˆ°æè‡´ã€‚</p><p>æœ¬å‘¨çš„ NShipster æˆ‘ä»¬å°†ä»¥ Swift è§†è§’æ¥è§‚å¯Ÿè¿™ä¸¤ä¸ªè¿è¡Œæ—¶ä¸­å…³äºå…³è”å¯¹è±¡(<a href=/associated-objects/>associated objects</a>)å’Œæ–¹æ³•äº¤å‰(<a href=/method-swizzling/>method swizzling</a>)çš„æŠ€æœ¯ã€‚</p><blockquote><p><em>æé†’ï¼š</em> æœ¬æ–‡ä¸»è¦ä» Swift è§’åº¦è®²è¿™ä¸¤ç§æŠ€æœ¯ï¼Œå¦‚æœéœ€è¦æ›´è¯¦ç»†çš„è§£é‡Šï¼Œè¯·å‚è€ƒä¸Šè¿°ä¸¤ç¯‡åŸæ–‡ã€‚</p></blockquote><h2 id=å…³è”å¯¹è±¡associated-objects>å…³è”å¯¹è±¡(Associated Objects)</h2><p>Swift extension èƒ½å¯¹å·²ç»å­˜åœ¨ Cocoa ç±»ä¸­æ·»åŠ æä¸ºä¸°å¯Œçš„åŠŸèƒ½ï¼Œä½†å®ƒçš„å…„å¼Ÿ Objective-C çš„ category å´é€Šè‰²äº†ä¸å°‘ã€‚æ¯”å¦‚è¯´ Objective-C ä¸­çš„ extension å°±æ— æ³•å‘æ—¢æœ‰ç±»æ·»åŠ å±æ€§ã€‚</p><p>ä»¤äººåº†å¹¸çš„æ˜¯ Objective-C çš„ <em>å…³è”å¯¹è±¡</em> å¯ä»¥ç¼“è§£è¿™ç§å±€é¢ã€‚ä¾‹å¦‚è¦å‘ä¸€ä¸ªå·¥ç¨‹é‡Œæ‰€æœ‰çš„ view controllers ä¸­æ·»åŠ ä¸€ä¸ª <code>descriptiveName</code> å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„ä½¿ç”¨ <code>objc_get/setAssociatedObject()</code>æ¥å¡«å……å…¶ <code>get</code> å’Œ <code>set</code> å—ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>UIViewController</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>AssociatedKeys</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>var</span> DescriptiveName = <span style=color:#e6db74>&#34;nsh_DescriptiveName&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> descriptiveName: String? {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>get</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> objc_getAssociatedObject(<span style=color:#66d9ef>self</span>, &amp;AssociatedKeys.DescriptiveName) <span style=color:#66d9ef>as</span>? String
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>set</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> newValue = newValue {
</span></span><span style=display:flex><span>                objc_setAssociatedObject(
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>self</span>,
</span></span><span style=display:flex><span>                    &amp;AssociatedKeys.DescriptiveName,
</span></span><span style=display:flex><span>                    newValue <span style=color:#66d9ef>as</span> NSString?,
</span></span><span style=display:flex><span>                    UInt(OBJC_ASSOCIATION_RETAIN_NONATOMIC)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>æ³¨æ„ï¼Œåœ¨ç§æœ‰åµŒå¥— <code>struct</code> ä¸­ä½¿ç”¨ <code>static var</code>ï¼Œè¿™æ ·ä¼šç”Ÿæˆæˆ‘ä»¬æ‰€éœ€çš„å…³è”å¯¹è±¡é”®ï¼Œä½†ä¸ä¼šæ±¡æŸ“æ•´ä¸ªå‘½åç©ºé—´ã€‚</p></blockquote><h2 id=æ–¹æ³•äº¤å‰method-swizzling>æ–¹æ³•äº¤å‰(Method Swizzling)</h2><p>æœ‰æ—¶ä¸ºäº†æ–¹ä¾¿ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯è§£å†³æŸäº›æ¡†æ¶å†…çš„ bugï¼Œæˆ–è€…åˆ«æ— ä»–æ³•æ—¶ï¼Œéœ€è¦ä¿®æ”¹ä¸€ä¸ªå·²ç»å­˜åœ¨ç±»çš„æ–¹æ³•çš„è¡Œä¸ºã€‚æ–¹æ³•äº¤å‰å¯ä»¥è®©ä½ äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°ï¼Œç›¸å½“äºæ˜¯ç”¨ä½ å†™çš„æ–¹æ³•æ¥é‡è½½åŸæœ‰æ–¹æ³•ï¼Œå¹¶ä¸”è¿˜èƒ½å¤Ÿæ˜¯åŸæœ‰æ–¹æ³•çš„è¡Œä¸ºä¿æŒä¸å˜ã€‚</p><p>è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬äº¤å‰ <code>UIViewController</code> çš„ <code>viewWillAppear</code> æ–¹æ³•ä»¥æ‰“å°å‡ºæ¯ä¸€ä¸ªåœ¨å±å¹•ä¸Šæ˜¾ç¤ºçš„ viewã€‚æ–¹æ³•äº¤å‰å‘ç”Ÿåœ¨ <code>initialize</code> ç±»æ–¹æ³•è°ƒç”¨æ—¶(å¦‚ä¸‹ä»£ç æ‰€ç¤º)ï¼›æ›¿ä»£çš„å®ç°åœ¨ <code>nsh_viewWillAppear</code> æ–¹æ³•ä¸­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>UIViewController</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>func</span> initialize() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Static</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>var</span> token: dispatch_once_t = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// make sure this isn&#39;t a subclass        </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>self</span> <span style=color:#f92672>!==</span> UIViewController.<span style=color:#66d9ef>self</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        dispatch_once(&amp;Static.token) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> originalSelector = Selector(<span style=color:#e6db74>&#34;viewWillAppear:&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> swizzledSelector = Selector(<span style=color:#e6db74>&#34;nsh_viewWillAppear:&#34;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> originalMethod = class_getInstanceMethod(<span style=color:#66d9ef>self</span>, originalSelector)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> swizzledMethod = class_getInstanceMethod(<span style=color:#66d9ef>self</span>, swizzledSelector)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> didAddMethod = class_addMethod(<span style=color:#66d9ef>self</span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod))
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> didAddMethod {
</span></span><span style=display:flex><span>                class_replaceMethod(<span style=color:#66d9ef>self</span>, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod))
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                method_exchangeImplementations(originalMethod, swizzledMethod);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - Method Swizzling</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>nsh_viewWillAppear</span>(animated: Bool) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.nsh_viewWillAppear(animated)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> name = <span style=color:#66d9ef>self</span>.descriptiveName {
</span></span><span style=display:flex><span>            println(<span style=color:#e6db74>&#34;viewWillAppear: </span><span style=color:#e6db74>\(</span>name<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            println(<span style=color:#e6db74>&#34;viewWillAppear: </span><span style=color:#e6db74>\(</span><span style=color:#66d9ef>self</span><span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=load-vs-initialize-swift-ç‰ˆæœ¬>load vs. initialize (Swift ç‰ˆæœ¬)</h3><p>Objective-C runtime ç†è®ºä¸Šä¼šåœ¨åŠ è½½å’Œåˆå§‹åŒ–ç±»çš„æ—¶å€™è°ƒç”¨ä¸¤ä¸ªç±»æ–¹æ³•ï¼š <code>load</code> and <code>initialize</code>ã€‚åœ¨è®²è§£ <a href=/method-swizzling/>method swizzling</a> çš„åŸæ–‡ä¸­ Mattt è€å¸ˆæŒ‡å‡ºå‡ºäºå®‰å…¨æ€§å’Œä¸€è‡´æ€§çš„è€ƒè™‘ï¼Œæ–¹æ³•äº¤å‰è¿‡ç¨‹ <em>æ°¸è¿œ</em> ä¼šåœ¨ <code>load()</code> æ–¹æ³•ä¸­è¿›è¡Œã€‚æ¯ä¸€ä¸ªç±»åœ¨åŠ è½½æ—¶åªä¼šè°ƒç”¨ä¸€æ¬¡ <code>load</code> æ–¹æ³•ã€‚å¦ä¸€æ–¹é¢ï¼Œä¸€ä¸ª <code>initialize</code> æ–¹æ³•å¯ä»¥è¢«ä¸€ä¸ªç±»å’Œå®ƒæ‰€æœ‰çš„å­ç±»è°ƒç”¨ï¼Œæ¯”å¦‚è¯´ <code>UIViewController</code> çš„è¯¥æ–¹æ³•ï¼Œå¦‚æœé‚£ä¸ªç±»æ²¡æœ‰è¢«ä¼ é€’ä¿¡æ¯ï¼Œé‚£ä¹ˆå®ƒçš„ <code>initialize</code> æ–¹æ³•å°±æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨äº†ã€‚</p><p>ä¸å¹¸çš„æ˜¯ï¼Œåœ¨ Swift ä¸­ <code>load</code> ç±»æ–¹æ³•æ°¸è¿œä¸ä¼šè¢« runtime è°ƒç”¨ï¼Œå› æ­¤æ–¹æ³•äº¤å‰å°±å˜æˆäº†ä¸å¯èƒ½çš„äº‹ã€‚ä½†æˆ‘ä»¬è¿˜æœ‰ä¸¤ä¸ªåŠæ³•ï¼š</p><ul><li><p><strong>åœ¨ <code>initialize</code> ä¸­å®ç°æ–¹æ³•äº¤å‰</strong>
è¿™ç§åšæ³•å¾ˆå®‰å…¨ï¼Œä½ åªéœ€è¦ç¡®ä¿ç›¸å…³çš„æ–¹æ³•äº¤å‰åœ¨ä¸€ä¸ª <code>dispatch_once</code> ä¸­å°±å¥½äº†(è¿™ä¹Ÿæ˜¯æœ€æ¨èçš„åšæ³•)ã€‚</p></li><li><p><strong>åœ¨ app delegate ä¸­å®ç°æ–¹æ³•äº¤å‰</strong>
ä¸åƒä¸Šé¢é€šè¿‡ç±»æ‰©å±•è¿›è¡Œæ–¹æ³•äº¤å‰ï¼Œè€Œæ˜¯ç®€å•åœ°åœ¨ app delegate çš„ <code>application(_:didFinishLaunchingWithOptions:)</code> æ–¹æ³•è°ƒç”¨æ—¶ä¸­æ‰§è¡Œç›¸å…³ä»£ç ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚åŸºäºå¯¹ç±»çš„ä¿®æ”¹ï¼Œè¿™ç§æ–¹æ³•åº”è¯¥å°±è¶³å¤Ÿç¡®ä¿è¿™äº›ä»£ç ä¼šè¢«æ‰§è¡Œåˆ°ã€‚</p></li></ul><hr><p>æœ€åï¼Œè¯·è®°ä½ä»…åœ¨ä¸å¾—å·²çš„æƒ…å†µä¸‹ä½¿ç”¨ Objective-C runtimeã€‚éšä¾¿ä¿®æ”¹åŸºç¡€æ¡†æ¶æˆ–æ‰€ä½¿ç”¨çš„ä¸‰æ–¹ä»£ç æ˜¯æ¯æ‰ä½ çš„åº”ç”¨çš„ç»ä½³æ–¹æ³•å“¦ã€‚è¯·åŠ¡å¿…è¦å°å¿ƒå“¦ã€‚</p><hr><p>é™¤é<a href=https://nshipster.cn/ target=_blank>å¦æœ‰å£°æ˜</a>ï¼Œæœ¬æ–‡é‡‡ç”¨çŸ¥è¯†å…±äº«ã€Œ<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>ç½²å-éå•†ä¸šæ€§ä½¿ç”¨ 3.0 ä¸­å›½å¤§é™†</a>ã€è®¸å¯åè®®æˆæƒã€‚</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top Â· å›é¡¶éƒ¨" rel=nofollow>&#127772;2015-01-26 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2026 Nate Cook ç‰ˆæƒæ‰€æœ‰</a><a href=https://autoptr.top/ title="Back to Home Â· å›é¦–é¡µ">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>æ ‡ç­¾:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>åˆ†ç±»:</span><li><a class=link href=https://autoptr.top/categories/Swift target=_blank>Swift</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>