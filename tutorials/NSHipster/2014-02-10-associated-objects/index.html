<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>Associated Objects</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="Associated Objects,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="Associated Objects,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"🌜"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>Associated Objects</span><span class=btRight><span title="Author · 作者" class=author>Mattt</span> <span title="Translator · 翻译" class=author>Croath Liu</span> <a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post · 关联或转载引用的文章" target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics · 回主题页">&#127793;</a></span></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#75715e>#import &lt;objc/runtime.h&gt;
</span></span></span></code></pre></div><p>Objective-C开发者应该小心谨慎地遵循这个危险咒语的各种准则。一个很好的原因的就是：混乱的运行时代码会改变运行在其架构之上的所有代码。</p><p>从利的角度来讲， <code>&lt;objc/runtime.h></code> 中的函数具有其他方式做不到的、能为应用和框架提供强大功能的能力。而从弊的角度来讲，它可能会会毁掉代码的<a href="https://en.wikipedia.org/wiki/Eternal_Darkness:_Sanity's_Requiem#Sanity_effects">sanity meter</a>，一切代码和逻辑都可能被异常糟糕的副作用影响(<a href="http://www.youtube.com/watch?v=RSXcajQnasc#t=0m30s">terrifying side-effects</a>)。</p><p>因此，我们怀着巨大的恐惧来思考这个与“魔鬼的交易”(<a href=https://en.wikipedia.org/wiki/Deal_with_the_Devil>Faustian bargain</a>)，一起来看看这个最多地被NSHipster读者们要求讲讲的主题之一：对象关联（associated objects）。</p><hr><p>对象关联（或称为关联引用）本来是Objective-C 2.0运行时的一个特性，起始于OS X Snow Leopard和iOS 4。相关参考可以查看 <code>&lt;objc/runtime.h></code> 中定义的以下三个允许你将任何键值在运行时关联到对象上的函数：</p><ul><li><code>objc_setAssociatedObject</code></li><li><code>objc_getAssociatedObject</code></li><li><code>objc_removeAssociatedObjects</code></li></ul><p>为什么我说这个很有用呢？因为这允许开发者<strong>对已经存在的类在扩展中添加自定义的属性</strong>，这几乎弥补了<a href=https://developer.apple.com/library/ios/documentation/cocoa/conceptual/ProgrammingWithObjectiveC/CustomizingExistingClasses/CustomizingExistingClasses.html>Objective-C最大的缺点</a>。</p><h4 id=nsobjectassociatedobjecth>NSObject+AssociatedObject.h</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>NSObject</span> (AssociatedObject)
</span></span><span style=display:flex><span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) <span style=color:#66d9ef>id</span> associatedObject;
</span></span><span style=display:flex><span><span style=color:#66d9ef>@end</span>
</span></span></code></pre></div><h4 id=nsobjectassociatedobjectm>NSObject+AssociatedObject.m</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#66d9ef>@implementation</span> <span style=color:#a6e22e>NSObject</span> (AssociatedObject)
</span></span><span style=display:flex><span><span style=color:#66d9ef>@dynamic</span> associatedObject;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>setAssociatedObject:</span>(<span style=color:#66d9ef>id</span>)object {
</span></span><span style=display:flex><span>     objc_setAssociatedObject(self, <span style=color:#66d9ef>@selector</span>(associatedObject), object, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- (<span style=color:#66d9ef>id</span>)<span style=color:#a6e22e>associatedObject</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> objc_getAssociatedObject(self, <span style=color:#66d9ef>@selector</span>(associatedObject));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>通常推荐的做法是添加的属性最好是 <code>static char</code> 类型的，当然更推荐是指针型的。通常来说该属性应该是常量、唯一的、在适用范围内用getter和setter访问到：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> kAssociatedObjectKey;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>objc_getAssociatedObject(self, <span style=color:#f92672>&amp;</span>kAssociatedObjectKey);
</span></span></code></pre></div><p>然而可以用更简单的方式实现：用selector。</p><blockquote class=twitter-tweet lang=en><p>Since <tt>SEL</tt>s are guaranteed to be unique and constant, you can use <tt>_cmd</tt> as the key for <tt>objc_setAssociatedObject()</tt>. <a href="https://twitter.com/search?q=%23objective&amp;src=hash">#objective</a>-c <a href="https://twitter.com/search?q=%23snowleopard&amp;src=hash">#snowleopard</a></p>&mdash; Bill Bumgarner (@bbum) <a href=https://twitter.com/bbum/statuses/3609098005>August 28, 2009</a></blockquote><script async src=//platform.twitter.com/widgets.js></script><h2 id=关联对象的行为>关联对象的行为</h2><p>属性可以根据定义在枚举类型 <code>objc_AssociationPolicy</code> 上的行为被关联在对象上：</p><table><thead><tr><th>Behavior</th><th><tt>@property</tt> Equivalent</th><th>Description</th></tr></thead><tbody><tr><td><tt>OBJC_ASSOCIATION_ASSIGN</tt></td><td><tt>@property (assign)</tt> 或 <tt>@property (unsafe_unretained)</tt></td><td>指定一个关联对象的弱引用。</td></tr><tr><td><tt>OBJC_ASSOCIATION_RETAIN_NONATOMIC</tt></td><td><tt>@property (nonatomic, strong)</tt></td><td>指定一个关联对象的强引用，不能被原子化使用。</td></tr><tr><td><tt>OBJC_ASSOCIATION_COPY_NONATOMIC</tt></td><td><tt>@property (nonatomic, copy)</tt></td><td>指定一个关联对象的copy引用，不能被原子化使用。</td></tr><tr><td><tt>OBJC_ASSOCIATION_RETAIN</tt></td><td><tt>@property (atomic, strong)</tt></td><td>指定一个关联对象的强引用，能被原子化使用。</td></tr><tr><td><tt>OBJC_ASSOCIATION_COPY</tt></td><td><tt>@property (atomic, copy)</tt></td><td>指定一个关联对象的copy引用，能被原子化使用。</td></tr></tbody></table><p>以 <code>OBJC_ASSOCIATION_ASSIGN</code> 类型关联在对象上的弱引用不代表0 retian的 <code>weak</code> 弱引用，行为上更像 <code>unsafe_unretained</code> 属性，所以当在你的视线中调用weak的关联对象时要相当小心。</p><blockquote><p>根据<a href=https://developer.apple.com/videos/wwdc/2011/#322-video>WWDC 2011, Session 322</a> (第36分钟左右)发布的内存销毁时间表，被关联的对象在生命周期内要比对象本身释放的晚很多。它们会在被 <code>NSObject -dealloc</code> 调用的 <code>object_dispose()</code> 方法中释放。</p></blockquote><h2 id=删除属性>删除属性</h2><p>你可以会在刚开始接触对象关联时想要尝试去调用 <code>objc_removeAssociatedObjects()</code> 来进行删除操作，但<a href=https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/Reference/reference.html#//apple_ref/c/func/objc_removeAssociatedObjects>如文档中所述</a>，你不应该自己手动调用这个函数：</p><blockquote><p>此函数的主要目的是在“初试状态”时方便地返回一个对象。你不应该用这个函数来删除对象的属性，因为可能会导致其他客户对其添加的属性也被移除了。规范的方法是：调用 <code>objc_setAssociatedObject</code> 方法并传入一个 <code>nil</code> 值来清除一个关联。</p></blockquote><h2 id=优秀样例>优秀样例</h2><ul><li>**添加私有属性用于更好地去实现细节。**当扩展一个内建类的行为时，保持附加属性的状态可能非常必要。注意以下说的是一种非常_教科书式_的关联对象的用例：AFNetworking在 <code>UIImageView</code> 的category上用了关联对象来<a href=https://github.com/AFNetworking/AFNetworking/blob/2.1.0/UIKit%2BAFNetworking/UIImageView%2BAFNetworking.m#L57-L63>保持一个operation对象</a>，用于从网络上某URL异步地获取一张图片。</li><li>**添加public属性来增强category的功能。**有些情况下这种(通过关联对象)让category行为更灵活的做法比在用一个带变量的方法来实现更有意义。在这些情况下，可以用关联对象实现一个一个对外开放的属性。回到上个AFNetworking的例子中的 <code>UIImageView</code> category，<a href=https://github.com/AFNetworking/AFNetworking/blob/2.1.0/UIKit%2BAFNetworking/UIImageView%2BAFNetworking.h#L60-L65>它的 <code>imageResponseSerializer</code></a>方法允许图片通过一个滤镜来显示、或在缓存到硬盘之前改变图片的内容。</li><li>**创建一个用于KVO的关联观察者。**当在一个category的实现中使用<a href=https://nshipster.com/key-value-observing/>KVO</a>时，建议用一个自定义的关联对象而不是该对象本身作观察者。</li></ul><h2 id=反例>反例</h2><ul><li>**当值不需要的时候建立一个关联对象。**一个常见的例子就是在view上创建一个方便的方法去保存来自model的属性、值或者其他混合的数据。如果那个数据在之后根本用不到，那么这种方法虽然是没什么问题的，但用关联到对象的做法并不可取。</li><li>**当一个值可以被其他值推算出时建立一个关联对象。**例如：在调用 <code>cellForRowAtIndexPath:</code> 时存储一个指向view的 <code>UITableViewCell</code> 中accessory view的引用，用于在 <code>tableView:accessoryButtonTappedForRowWithIndexPath:</code> 中使用。</li><li><strong>用关联对象替代X</strong>，这里的X可以代表下列含义：<ul><li>当继承比扩展原有的类更方便时用<a href=https://developer.apple.com/library/ios/documentation/cocoa/conceptual/ProgrammingWithObjectiveC/CustomizingExistingClasses/CustomizingExistingClasses.html>子类化</a>。</li><li>为事件的响应者添加<a href=https://developer.apple.com/library/ios/documentation/general/conceptual/Devpedia-CocoaApp/TargetAction.html>响应动作</a>。</li><li>当响应动作不方便使用时使用的<a href=https://developer.apple.com/library/ios/documentation/EventHandling/Conceptual/EventHandlingiPhoneOS/GestureRecognizer_basics/GestureRecognizer_basics.html>手势动作捕捉</a>。</li><li>行为可以在其他对象中被代理实现时要用<a href=https://developer.apple.com/library/ios/documentation/general/conceptual/DevPedia-CocoaCore/Delegation.html>代理(delegate)</a>。</li><li>用<a href=https://nshipster.com/nsnotification-and-nsnotificationcenter/>NSNotification 和 NSNotificationCenter</a>进行松耦合化的跨系统的事件通知。</li></ul></li></ul><hr><p>比起其他解决问题的方法，关联对象应该被视为最后的选择（事实上category也不应该作为首选方法）。</p><p>和其他精巧的trick、hack、workaround一样，一般人都会在刚学习完之后乐于寻找场景去使用一下。尽你所能去理解和欣赏它在正确使用时它所发挥的作用，同时当你选择_这个_解决办法时，也要避免当被轻蔑地问起“这是个什么玩意？”时的尴尬。</p><hr><p>除非<a href=https://nshipster.cn/ target=_blank>另有声明</a>，本文采用知识共享「<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>署名-非商业性使用 3.0 中国大陆</a>」许可协议授权。</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top · 回顶部" rel=nofollow>&#127772;2014-02-10 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2025 Mattt 版权所有</a><a href=https://autoptr.top/ title="Back to Home · 回首页">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>标签:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>分类:</span><li><a class=link href=https://autoptr.top/categories/Objective-C target=_blank>Objective-C</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>