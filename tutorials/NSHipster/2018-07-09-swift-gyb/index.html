<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>Swift GYB</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="Swift GYB,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="Swift GYB,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"🌜"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>Swift GYB</span><span class=btRight><span title="Author · 作者" class=author>Mattt</span> <span title="Translator · 翻译" class=author>Bei Li</span> <a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post · 关联或转载引用的文章" target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics · 回主题页">&#127793;</a></span></h1><p>「boilerplate」这个词可以追溯到印刷媒体早期。本地小报需要内容来填满他们报纸的版面，但又通常没有足够的内容，所以很多本地小报通过大型印刷集团来获取稳定的内容，来填充报纸的最后几页。这些内容通常由预制的印板（plate）提供，这些印板长的很像曾经用来制作锅炉（boiler）的卷起来的钢板。因此有了「boiler-plate」这个词语。</p><p>经过转喻，这些内容本身被称作「boilerplate」，并且这个概念被拓展到包括标准化和公式化的文本。这些文本出现在合同和套用信函（form letter）里，以及与本周 NSHipster 文章最相关的东西——代码。</p><hr><p>并不是所有的代码都那么光鲜亮丽，其实很多工作都是通过底层的 boilerplate 来工作的。</p><p>Swift 标准库也是这样，它有诸如符号整数（<code>Int8</code>, <code>Int16</code>, <code>Int32</code>, <code>Int64</code>）这样的类型家族，其中各个类型的实现除大小之外没有其他不同。</p><p>拷贝粘贴可以作为一次性的解决方案（假设你第一次就做的没有错误），但这种方法无法继续维护。每当你想修改这些派生的实现，都会有引入细微不一致的风险，久而久之导致这些实现变得不相同——有一点类似于地球上生命的多样性是因为基因随机突变导致的一样。</p><p>从 C++ 模板和 Lisp 宏到 <code>eval</code> 和 C 预处理器指令，不同的语言使用不同的技术来应对这个问题。</p><p>Swift 没有宏系统，并且因为标准库本身是使用 Swift 编写的，所以它也不能利用 C++ 元编程的能力。因此，Swift 的维护者们使用一个叫作 <a href=https://github.com/apple/swift/blob/master/utils/gyb.py>gyb.py</a> 的 Python 脚本和一些模板标签来生成代码。</p><blockquote><p>GYB 是「Generate Your Boilerplate」的缩写，参考了另一个 Python 工具 <a href=https://gyp.gsrc.io>GYP</a> 即「Generate Your Projects」。</p></blockquote><h2 id=gyb-是如何工作的>GYB 是如何工作的</h2><p>GYB 是一个允许你使用 Python 代码来做变量替换和流程控制的轻量模板系统：</p><ul><li><code>%{ &lt;#code#> }</code> 执行一段 Python 代码</li><li><code>% &lt;#code#>: ... % end</code> 进行流程控制</li><li><code>${ &lt;#code#> }</code> 会被替换为表达式的结果</li></ul><p>其他输入的文本则不会改变。</p><p><a href=https://github.com/apple/swift/blob/master/stdlib/public/core/Codable.swift.gyb>Codable.swift.gyb</a> 是 GYB 一个很好的例子。在文件的顶部，基础 <code>Codable</code> 类型被赋值给一个实例变量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>%</span>{
</span></span><span style=display:flex><span>codable_types <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;Bool&#39;</span>, <span style=color:#e6db74>&#39;String&#39;</span>, <span style=color:#e6db74>&#39;Double&#39;</span>, <span style=color:#e6db74>&#39;Float&#39;</span>,
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>&#39;Int&#39;</span>, <span style=color:#e6db74>&#39;Int8&#39;</span>, <span style=color:#e6db74>&#39;Int16&#39;</span>, <span style=color:#e6db74>&#39;Int32&#39;</span>, <span style=color:#e6db74>&#39;Int64&#39;</span>,
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>&#39;UInt&#39;</span>, <span style=color:#e6db74>&#39;UInt8&#39;</span>, <span style=color:#e6db74>&#39;UInt16&#39;</span>, <span style=color:#e6db74>&#39;UInt32&#39;</span>, <span style=color:#e6db74>&#39;UInt64&#39;</span>]
</span></span><span style=display:flex><span>}<span style=color:#f92672>%</span>
</span></span></code></pre></div><p>之后，在 <code>SingleValueEncodingContainer</code> 的实现中，这些类型被用来循环生成协议要求的方法声明：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>%</span> <span style=color:#66d9ef>for</span> type <span style=color:#f92672>in</span> codable_types:
</span></span><span style=display:flex><span>  mutating func encode(_ value: <span style=color:#960050;background-color:#1e0010>$</span>{type}) throws
</span></span><span style=display:flex><span><span style=color:#f92672>%</span> end
</span></span></code></pre></div><p>执行这个 GYB 模板会得到下面这些声明：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: Bool) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: String) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: Double) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: Float) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: Int) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: Int8) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: Int16) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: Int32) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: Int64) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: UInt) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: UInt8) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: UInt16) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: UInt32) <span style=color:#66d9ef>throws</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mutating</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>encode</span>(<span style=color:#66d9ef>_</span> value: UInt64) <span style=color:#66d9ef>throws</span>
</span></span></code></pre></div><p>这个模式的使用贯穿整个文件，用来给像 <code>encode(_:forKey:)</code>，<code>decode(_:forKey:)</code> 和 <code>decodeIfPresent(_:forKey:)</code> 这样的方法生成相似、公式化的声明。GYB 减少了几千行 boilerplate 代码：</p><pre tabindex=0><code class=language-terminal data-lang=terminal>$ wc -l Codable.swift.gyb
2183 Codable.swift.gyb
$ wc -l Codable.swift
5790 Codable.swift
</code></pre><blockquote><p>注意：有效的 GYB 模板不一定能生成有效的 Swift 代码。如果在派生的文件中出现编译错误，可能将很难查明根本原因。</p></blockquote><h2 id=在-xcode-中使用-gyb>在 Xcode 中使用 GYB</h2><p>GYB 并不是 Xcode 标准工具链的一部分，所以你并不能在 <code>xcrun</code> 里找到它。你可以下载源码并使用 <code>chmod</code> 命令使 <code>gyb</code> 成为可执行文件（macOS 默认安装的 Python 应该是可以运行 <code>gyb</code> 的）：</p><pre tabindex=0><code class=language-terminal data-lang=terminal>$ wget https://github.com/apple/swift/raw/master/utils/gyb
$ wget https://github.com/apple/swift/raw/master/utils/gyb.py
$ chmod +x gyb
</code></pre><p>将这些命令放置到能被你的 Xcode 项目访问到，但与源代码文件不同的地方。比如说项目根目录下一个叫 <code>Vendor</code> 的目录下。</p><p>在 Xcode 中，点击 project navigator 中蓝色的项目文件图标，选择项目中正在使用的 target，并去到「Build Phases」面板。在面板顶部，你可以找到一个可以点击的 + 符号，用来增加新的编译阶段。选择「Add New Run Script Phase」，并将下面的代码输入编辑器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>find . -name <span style=color:#e6db74>&#39;*.gyb&#39;</span> |                                               <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#66d9ef>while</span> read file; <span style=color:#66d9ef>do</span>                                              <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        ./path/to/gyb --line-directive <span style=color:#e6db74>&#39;&#39;</span> -o <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>file%.gyb<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#66d9ef>done</span>
</span></span></code></pre></div><blockquote><p>请确保 GYB 编译阶段放置在「Compile Sources」之前。</p></blockquote><p>现在当你编译你的项目时，任何文件扩展名为 <code>.swift.gyb</code> 的文件会被 GYB 执行并产出 <code>.swift</code> 文件，之后与项目中其他的代码一起编译。</p><h2 id=何时使用-gyb>何时使用 GYB</h2><p>和其他工具一样，知道何时使用 GYB 与知道如何使用 GYB 同样重要。下面有一些你可能会想要使用 GYB 的例子。</p><h3 id=生成公式化代码>生成公式化代码</h3><p>你是否为集合或者序列中的元素复制粘贴相同的代码？for-in 循环和变量替换可以解决这个问题。</p><p>和之前在 <code>Codable</code> 的例子里看到的一样，你可以在 GYB 模板文件的顶部声明一个集合，然后迭代这个集合来生成类型、属性或者方法声明：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>%</span>{ abilities <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;strength&#39;</span>, <span style=color:#e6db74>&#39;dexterity&#39;</span>, <span style=color:#e6db74>&#39;constitution&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;intelligence&#39;</span>, <span style=color:#e6db74>&#39;wisdom&#39;</span>, <span style=color:#e6db74>&#39;charisma&#39;</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Character</span> {
</span></span><span style=display:flex><span>  var name: String
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>%</span> <span style=color:#66d9ef>for</span> ability <span style=color:#f92672>in</span> abilities:
</span></span><span style=display:flex><span>  var <span style=color:#960050;background-color:#1e0010>$</span>{type}: Int
</span></span><span style=display:flex><span><span style=color:#f92672>%</span> end
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>大量的重复代码也常常意味着或许能有更好的解决方法。像协议扩展和泛型这些语言内置的功能可以消灭大量的重复代码，注意是否可以使用这些功能而不是一昧的使用 GYB。</p><h3 id=从数据派生代码>从数据派生代码</h3><p>你是否在根据数据源来编写代码？那么尝试将 GYB 加入开发过程吧！</p><p>GYB 文件可以导入像 <code>json</code>，<code>xml</code> 和 <code>csv</code> 这些 Python 包，你几乎可以解析任何你遇到的文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>%</span>{ <span style=color:#f92672>import</span> csv }
</span></span><span style=display:flex><span><span style=color:#f92672>%</span> <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;path/to/file.csv&#39;</span>) <span style=color:#66d9ef>as</span> file:
</span></span><span style=display:flex><span>    <span style=color:#f92672>%</span> <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> csv<span style=color:#f92672>.</span>DictReader(file):
</span></span></code></pre></div><p>如果你想看看这方面的实践，看看 <a href=https://github.com/Flight-School/Money/blob/master/Sources/Money/Currency.swift.gyb>Currencies.swift.gyb</a>，它给 <a href=https://www.iso.org/iso-4217-currency-codes.html>ISO 4217</a> 标准定义的每个货币生成对应的 Swift 枚举类型。</p><blockquote><p>为了保持编译速度和确定性，应该将数据下载到文件并放入版本控制，而不是在 GYB 文件中执行 HTTP 请求或者数据库查询。</p></blockquote><p>代码生成让代码和相关标准之间保持同步变得简单。只需要更新数据文件再重新运行 GYB 就可以了。</p><hr><p>Swift 最近通过编译器合成代码减少了很多 boilerplate 代码, 像 4.0 中的 <code>Encodable</code> 和 <code>Decodable</code>，4.1 中的 <code>Equatable</code> 和 <code>Hashable</code>，4.2 中的 <code>CaseIterable</code>。</p><p>与此同时，对于其他代码来说，GYB 是一个非常实用的代码生成工具。</p><blockquote><p><a href=https://github.com/krzysztofzablocki/Sourcery>Sourcery</a> 是社区中另一个好用的工具，它让你可以使用 Swift（通过 <a href=https://github.com/stencilproject/Stencil>Stencil</a>）而不是 Python 来编写模板。</p></blockquote><p>「Don&rsquo;t Repeat Yourself」可能是编程中的美德，但是有些时候你需要重复一些事情来完成工作。当你需要重复的时候，你将会感谢有像 GYB 这样的工具来帮助你。</p><hr><p>除非<a href=https://nshipster.cn/ target=_blank>另有声明</a>，本文采用知识共享「<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>署名-非商业性使用 3.0 中国大陆</a>」许可协议授权。</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top · 回顶部" rel=nofollow>&#127772;2018-07-09 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2025 Mattt 版权所有</a><a href=https://autoptr.top/ title="Back to Home · 回首页">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>标签:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>分类:</span><li><a class=link href=https://autoptr.top/categories/Swift target=_blank>Swift</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>