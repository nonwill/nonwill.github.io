<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>JavaScriptCore</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="JavaScriptCore,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="JavaScriptCore,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"🌜"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>JavaScriptCore</span><span class=btRight><span title="Author · 作者" class=author>Nate Cook</span> <span title="Translator · 翻译" class=author>April Peng</span> <a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post · 关联或转载引用的文章" target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics · 回主题页">&#127793;</a></span></h1><p><a href=http://redmonk.com/sogrady/category/programming-languages/>这个星期</a>流行编程语言的最新排名结果是，Swift 迅速从第 68 位跃升到 22 位，而 Objective-C 仍然稳固的占据在第 10 位。但是，说到允许在 iOS 上运行的其他语言 上，这两个都被甩的很远：当前的冠军是 JavaScript。</p><p>OS X Mavericks 和 iOS 7 引入了 JavaScriptCore 库，它把 WebKit 的 JavaScript 引擎用 Objective-C 封装，提供了简单，快速以及安全的方式接入世界上最流行的语言。不管你爱它还是恨它，JavaScript 的普遍存在使得程序员、工具以及融合到 OS X 和 iOS 里这样超快的虚拟机中资源的使用都大幅增长。</p><p>这样一来，先抛开动态和类型安全的痛苦辩论，让我带你一起来做一个 <em>JavaScriptCore 的观光。</em></p><hr><h3 id=jscontext--jsvalue><code>JSContext</code> / <code>JSValue</code></h3><p><code>JSContext</code> 是运行 JavaScript 代码的环境。一个 <code>JSContext</code> 是一个全局环境的实例，如果你写过一个在浏览器内运行的 JavaScript，<code>JSContext</code> 类似于 <code>window</code>。创建一个 <code>JSContext</code> 后，可以很容易地运行 JavaScript 代码来创建变量，做计算，甚至定义方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> context = JSContext()
</span></span><span style=display:flex><span>context.evaluateScript(<span style=color:#e6db74>&#34;var num = 5 + 5&#34;</span>)
</span></span><span style=display:flex><span>context.evaluateScript(<span style=color:#e6db74>&#34;var names = [&#39;Grace&#39;, &#39;Ada&#39;, &#39;Margaret&#39;]&#34;</span>)
</span></span><span style=display:flex><span>context.evaluateScript(<span style=color:#e6db74>&#34;var triple = function(value) { return value * 3 }&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> tripleNum: JSValue = context.evaluateScript(<span style=color:#e6db74>&#34;triple(num)&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>JSContext <span style=color:#f92672>*</span>context <span style=color:#f92672>=</span> [[JSContext alloc] init];
</span></span><span style=display:flex><span>[context evaluateScript:<span style=color:#e6db74>@&#34;var num = 5 + 5&#34;</span>];
</span></span><span style=display:flex><span>[context evaluateScript:<span style=color:#e6db74>@&#34;var names = [&#39;Grace&#39;, &#39;Ada&#39;, &#39;Margaret&#39;]&#34;</span>];
</span></span><span style=display:flex><span>[context evaluateScript:<span style=color:#e6db74>@&#34;var triple = function(value) { return value * 3 }&#34;</span>];
</span></span><span style=display:flex><span>JSValue <span style=color:#f92672>*</span>tripleNum <span style=color:#f92672>=</span> [context evaluateScript:<span style=color:#e6db74>@&#34;triple(num)&#34;</span>];
</span></span></code></pre></div><p>代码的最后一行，任何<em>出自</em> <code>JSContext</code> 的值都被包裹在一个 <code>JSValue</code> 对象中。像 JavaScript 这样的动态语言需要一个动态类型，所以 <code>JSValue</code> 包装了每一个可能的 JavaScript 值：字符串和数字；数组、对象和方法；甚至错误和特殊的 JavaScript 值诸如 <code>null</code> 和 <code>undefined</code>。</p><p><code>JSValue</code> 包括一系列方法用于访问其可能的值以保证有正确的 Foundation 类型，包括：</p><table><thead><tr><th>JavaScript Type</th><th><code>JSValue</code> method</th><th>Objective-C Type</th><th>Swift Type</th></tr></thead><tbody><tr><td>string</td><td><code>toString</code></td><td><code>NSString</code></td><td><code>String!</code></td></tr><tr><td>boolean</td><td><code>toBool</code></td><td><code>BOOL</code></td><td><code>Bool</code></td></tr><tr><td>number</td><td><code>toNumber</code><br><code>toDouble</code><br><code>toInt32</code><br><code>toUInt32</code></td><td><code>NSNumber</code><br><code>double</code><br><code>int32_t</code><br><code>uint32_t</code></td><td><code>NSNumber!</code><br><code>Double</code><br><code>Int32</code><br><code>UInt32</code></td></tr><tr><td>Date</td><td><code>toDate</code></td><td><code>NSDate</code></td><td><code>NSDate!</code></td></tr><tr><td>Array</td><td><code>toArray</code></td><td><code>NSArray</code></td><td><code>[AnyObject]!</code></td></tr><tr><td>Object</td><td><code>toDictionary</code></td><td><code>NSDictionary</code></td><td><code>[NSObject : AnyObject]!</code></td></tr><tr><td>Object</td><td><code>toObject</code><br><code>toObjectOfClass:</code></td><td><em>custom type</em></td><td><em>custom type</em></td></tr></tbody></table><p>从上面的例子中得到 <code>tripleNum</code> 的值，只需使用适当的方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>println(<span style=color:#e6db74>&#34;Tripled: </span><span style=color:#e6db74>\(</span>tripleNum.toInt32<span style=color:#e6db74>())</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// Tripled: 30</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>NSLog(<span style=color:#e6db74>@&#34;Tripled: %d&#34;</span>, [tripleNum toInt32]);
</span></span><span style=display:flex><span><span style=color:#75715e>// Tripled: 30
</span></span></span></code></pre></div><h3 id=下标值>下标值</h3><p>对 <code>JSContext</code> 和 <code>JSValue</code> 实例使用下标的方式我们可以很容易地访问我们之前创建的 <code>context</code> 的任何值。<code>JSContext</code> 需要一个字符串下标，而 <code>JSValue</code> 允许使用字符串或整数标来得到里面的对象和数组：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> names = context.objectForKeyedSubscript(<span style=color:#e6db74>&#34;names&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> initialName = names.objectAtIndexedSubscript(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>println(<span style=color:#e6db74>&#34;The first name: </span><span style=color:#e6db74>\(</span>initialName.toString<span style=color:#e6db74>())</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// The first name: Grace</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>JSValue <span style=color:#f92672>*</span>names <span style=color:#f92672>=</span> context[<span style=color:#e6db74>@&#34;names&#34;</span>];
</span></span><span style=display:flex><span>JSValue <span style=color:#f92672>*</span>initialName <span style=color:#f92672>=</span> names[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>NSLog(<span style=color:#e6db74>@&#34;The first name: %@&#34;</span>, [initialName toString]);
</span></span><span style=display:flex><span><span style=color:#75715e>// The first name: Grace
</span></span></span></code></pre></div><blockquote><p>Swift 展示了它的青涩，在这里，Objective-C 代码可以利用下标表示法，Swift 目前只公开<a href=/object-subscripting/>原始方法</a>来让下标成为可能：<code>objectAtKeyedSubscript()</code> 和 <code>objectAtIndexedSubscript()</code>。</p></blockquote><h3 id=调用方法>调用方法</h3><p><code>JSValue</code> 包装了一个 JavaScript 函数，我们可以从 Objective-C / Swift 代码中使用 Foundation 类型作为参数来直接调用该函数。再次，JavaScriptCore 很轻松的处理了这个桥接：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> tripleFunction = context.objectForKeyedSubscript(<span style=color:#e6db74>&#34;triple&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> result = tripleFunction.callWithArguments([<span style=color:#ae81ff>5</span>])
</span></span><span style=display:flex><span>println(<span style=color:#e6db74>&#34;Five tripled: </span><span style=color:#e6db74>\(</span>result.toInt32<span style=color:#e6db74>())</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>JSValue <span style=color:#f92672>*</span>tripleFunction <span style=color:#f92672>=</span> context[<span style=color:#e6db74>@&#34;triple&#34;</span>];
</span></span><span style=display:flex><span>JSValue <span style=color:#f92672>*</span>result <span style=color:#f92672>=</span> [tripleFunction callWithArguments:<span style=color:#ae81ff>@[</span><span style=color:#ae81ff>@5</span><span style=color:#ae81ff>]</span> ];
</span></span><span style=display:flex><span>NSLog(<span style=color:#e6db74>@&#34;Five tripled: %d&#34;</span>, [result toInt32]);
</span></span></code></pre></div><h3 id=错误处理>错误处理</h3><p><code>JSContext</code> 还有另外一个有用的招数：通过设置上下文的 <code>exceptionHandler</code> 属性，你可以观察和记录语法，类型以及运行时错误。 <code>exceptionHandler</code> 是一个接收一个 <code>JSContext</code> 引用和异常本身的回调处理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>context.exceptionHandler = { context, exception <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    println(<span style=color:#e6db74>&#34;JS Error: </span><span style=color:#e6db74>\(</span>exception<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>context.evaluateScript(<span style=color:#e6db74>&#34;function multiply(value1, value2) { return value1 * value2 &#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// JS Error: SyntaxError: Unexpected end of script</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>context.exceptionHandler <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(JSContext <span style=color:#f92672>*</span>context, JSValue <span style=color:#f92672>*</span>exception) {
</span></span><span style=display:flex><span>   NSLog(<span style=color:#e6db74>@&#34;JS Error: %@&#34;</span>, exception);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[context evaluateScript:<span style=color:#e6db74>@&#34;function multiply(value1, value2) { return value1 * value2 &#34;</span>];
</span></span><span style=display:flex><span><span style=color:#75715e>// JS Error: SyntaxError: Unexpected end of script
</span></span></span></code></pre></div><h2 id=javascript-调用>JavaScript 调用</h2><p>现在我们知道了如何从 JavaScript 环境中提取值以及如何调用其中定义的函数。那么反向呢？我们怎样才能从 JavaScript 访问我们在 Objective-C 或 Swift 定义的对象和方法？</p><p>让 <code>JSContext</code> 访问我们的本地客户端代码的方式主要有两种：block 和 <code>JSExport</code> 协议。</p><h3 id=blocks>Blocks</h3><p>当一个 Objective-C block
被赋给 <code>JSContext</code> 里的一个标识符，JavaScriptCore 会自动的把 block 封装在 JavaScript 函数里。这使得在 JavaScript 中可以简单的使用 Foundation 和 Cocoa 类，所有的桥接都为你做好了。见证了 <code>CFStringTransform</code> 的强大威力，现在让我们来看看 JavaScript：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> simplifyString: @objc_block String -&gt; String = { input <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> mutableString = NSMutableString(string: input) <span style=color:#66d9ef>as</span> CFMutableStringRef
</span></span><span style=display:flex><span>    CFStringTransform(mutableString, <span style=color:#66d9ef>nil</span>, kCFStringTransformToLatin, Boolean(<span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>    CFStringTransform(mutableString, <span style=color:#66d9ef>nil</span>, kCFStringTransformStripCombiningMarks, Boolean(<span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mutableString
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>context.setObject(unsafeBitCast(simplifyString, AnyObject.<span style=color:#66d9ef>self</span>), forKeyedSubscript: <span style=color:#e6db74>&#34;simplifyString&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>println(context.evaluateScript(<span style=color:#e6db74>&#34;simplifyString(&#39;안녕하새요!&#39;)&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#75715e>// annyeonghasaeyo!</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>context[<span style=color:#e6db74>@&#34;simplifyString&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(NSString <span style=color:#f92672>*</span>input) {
</span></span><span style=display:flex><span>   NSMutableString <span style=color:#f92672>*</span>mutableString <span style=color:#f92672>=</span> [input mutableCopy];
</span></span><span style=display:flex><span>   CFStringTransform((<span style=color:#66d9ef>__bridge</span> CFMutableStringRef)mutableString, NULL, kCFStringTransformToLatin, NO);
</span></span><span style=display:flex><span>   CFStringTransform((<span style=color:#66d9ef>__bridge</span> CFMutableStringRef)mutableString, NULL, kCFStringTransformStripCombiningMarks, NO);
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> mutableString;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NSLog(<span style=color:#e6db74>@&#34;%@&#34;</span>, [context evaluateScript:<span style=color:#e6db74>@&#34;simplifyString(&#39;안녕하새요!&#39;)&#34;</span>]);
</span></span></code></pre></div><blockquote><p>在这儿，Swfit 还有一个坑，请注意，这仅适用于 <em>Objective-C 的 block</em>，而不是 Swift 的闭包。要在 <code>JSContext</code> 中使用 Swift 闭包，它需要（a）与 <code>@ objc_block</code> 属性一起声明，以及（b）使用 Swift 那个令人恐惧的 <code>unsafeBitCast()</code> 函数转换为 <code>AnyObject</code> 。</p></blockquote><h4 id=内存管理>内存管理</h4><p>由于 block 可以保有变量引用，而且 <code>JSContext</code> 也强引用它所有的变量，为了避免强引用循环需要特别小心。避免保有你的 <code>JSContext</code> 或一个 block 里的任何 <code>JSValue</code>。相反，使用 <code>[JSContext currentContext]</code> 得到当前上下文，并把你需要的任何值用参数传递。</p><h3 id=jsexport-协议><code>JSExport</code> 协议</h3><p>另一种在 JavaScript 代码中使用我们的自定义对象的方法是添加 <code>JSExport</code> 协议。无论我们在 <code>JSExport</code> 里声明的属性，实例方法还是类方法，继承的协议都会<em>自动的</em>提供给任何 JavaScript 代码。我们将在下一节看到。</p><h2 id=javascriptcore-实战>JavaScriptCore 实战</h2><p>让我们做一个使用了所有这些不同的技术的示例 - 我们将定义一个 <code>Person</code> 模型符合 <code>JSExport</code> 子协议 <code>PersonJSExports</code> 的例子，然后使用 JavaScript 从 JSON 文件中创建并填充实例。都有一个完整的 JVM 在那儿了，谁还需要 <code>NSJSONSerialization</code>？</p><h3 id=1-personjsexports-和-person>1) <code>PersonJSExports</code> 和 <code>Person</code></h3><p>我们的 <code>Person</code> 类实现了 <code>PersonJSExports</code> 协议，该协议规定哪些属性在 JavaScript 中可用。</p><blockquote><p>由于 JavaScriptCore <em>没有</em>初始化，所以 <code>create...</code> 类方法是必要的，我们不能像原生的 JavaScript 类型那样简单地用 <code>var person = new Person()</code>。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// Custom protocol must be declared with `@objc`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@objc</span> <span style=color:#66d9ef>protocol</span> <span style=color:#a6e22e>PersonJSExports</span> : JSExport {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> firstName: String { <span style=color:#66d9ef>get</span> <span style=color:#66d9ef>set</span> }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> lastName: String { <span style=color:#66d9ef>get</span> <span style=color:#66d9ef>set</span> }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> birthYear: NSNumber? { <span style=color:#66d9ef>get</span> <span style=color:#66d9ef>set</span> }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getFullName</span>() -&gt; String
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/// create and return a new Person instance with `firstName` and `lastName`</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>func</span> createWithFirstName(firstName: String, lastName: String) -&gt; Person
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Custom class must inherit from `NSObject`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@objc</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span> : NSObject, PersonJSExports {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// properties must be declared as `dynamic`</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>dynamic</span> <span style=color:#66d9ef>var</span> firstName: String
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>dynamic</span> <span style=color:#66d9ef>var</span> lastName: String
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>dynamic</span> <span style=color:#66d9ef>var</span> birthYear: NSNumber?
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>init</span>(firstName: String, lastName: String) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.firstName = firstName
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.lastName = lastName
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>func</span> createWithFirstName(firstName: String, lastName: String) -&gt; Person {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Person(firstName: firstName, lastName: lastName)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getFullName</span>() -&gt; String {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>\(</span>firstName<span style=color:#e6db74>)</span><span style=color:#e6db74> </span><span style=color:#e6db74>\(</span>lastName<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#75715e>// in Person.h -----------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>@class</span> <span style=color:#a6e22e>Person</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@protocol</span> <span style=color:#a6e22e>PersonJSExports</span> <span style=color:#f92672>&lt;</span>JSExport<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) NSString <span style=color:#f92672>*</span>firstName;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) NSString <span style=color:#f92672>*</span>lastName;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@property</span> NSInteger ageToday;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span> (NSString <span style=color:#f92672>*</span>)getFullName;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// create and return a new Person instance with `firstName` and `lastName`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>+</span> (<span style=color:#66d9ef>instancetype</span>)createWithFirstName:(NSString <span style=color:#f92672>*</span>)firstName lastName:(NSString <span style=color:#f92672>*</span>)lastName;
</span></span><span style=display:flex><span><span style=color:#66d9ef>@end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>Person</span> : <span style=color:#a6e22e>NSObject</span> <span style=color:#f92672>&lt;</span>PersonJSExports<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) NSString <span style=color:#f92672>*</span>firstName;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) NSString <span style=color:#f92672>*</span>lastName;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>@property</span> NSInteger ageToday;
</span></span><span style=display:flex><span><span style=color:#66d9ef>@end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// in Person.m -----------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>@implementation</span> <span style=color:#a6e22e>Person</span>
</span></span><span style=display:flex><span>- (NSString <span style=color:#f92672>*</span>)<span style=color:#a6e22e>getFullName</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [NSString stringWithFormat:<span style=color:#e6db74>@&#34;%@ %@&#34;</span>, self.firstName, self.lastName];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>+ (<span style=color:#66d9ef>instancetype</span>) <span style=color:#a6e22e>createWithFirstName:</span>(NSString <span style=color:#f92672>*</span>)firstName <span style=color:#a6e22e>lastName:</span>(NSString <span style=color:#f92672>*</span>)lastName {
</span></span><span style=display:flex><span>    Person <span style=color:#f92672>*</span>person <span style=color:#f92672>=</span> [[Person alloc] init];
</span></span><span style=display:flex><span>    person.firstName <span style=color:#f92672>=</span> firstName;
</span></span><span style=display:flex><span>    person.lastName <span style=color:#f92672>=</span> lastName;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> person;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>@end</span>
</span></span></code></pre></div><h3 id=2-jscontext-配置>2) <code>JSContext</code> 配置</h3><p>之前，我们可以用我们已经创建的 <code>Person</code> 类，我们需要将其导出到 JavaScript 环境。我们也将借此导入 <a href=http://mustache.github.io/>Mustache JS library</a>，我们将应用模板到我们的 <code>Person</code> 对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// export Person class</span>
</span></span><span style=display:flex><span>context.setObject(Person.<span style=color:#66d9ef>self</span>, forKeyedSubscript: <span style=color:#e6db74>&#34;Person&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// load Mustache.js</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> mustacheJSString = String(contentsOfFile:..., encoding:NSUTF8StringEncoding, error:<span style=color:#66d9ef>nil</span>) {
</span></span><span style=display:flex><span>    context.evaluateScript(mustacheJSString)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#75715e>// export Person class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>context[<span style=color:#e6db74>@&#34;Person&#34;</span>] <span style=color:#f92672>=</span> [Person <span style=color:#66d9ef>class</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// load Mustache.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>NSString <span style=color:#f92672>*</span>mustacheJSString <span style=color:#f92672>=</span> [NSString stringWithContentsOfFile:... encoding:NSUTF8StringEncoding error:nil];
</span></span><span style=display:flex><span>[context evaluateScript:mustacheJSString];
</span></span></code></pre></div><h3 id=3-javascript-数据和进程>3) JavaScript 数据和进程</h3><p>下面就来看看我们简单的 JSON 例子，这段代码将创建新的 <code>Person</code> 实例。</p><blockquote><p>注意：JavaScriptCore 转换的 Objective-C / Swift 方法名是 JavaScript 兼容的。由于 JavaScript 没有参数 名称，任何外部参数名称都会被转换为驼峰形式并且附加到函数名后。在这个例子中，Objective-C 的方法 <code>createWithFirstName:lastName:</code> 变成了在JavaScript中的 <code>createWithFirstNameLastName()</code>。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JavaScript data-lang=JavaScript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>loadPeopleFromJSON</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>jsonString</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>jsonString</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>people</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>person</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Person</span>.<span style=color:#a6e22e>createWithFirstNameLastName</span>(<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>first</span>, <span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>last</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>person</span>.<span style=color:#a6e22e>birthYear</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>year</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>people</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>person</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>people</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>[
</span></span><span style=display:flex><span>    { <span style=color:#f92672>&#34;first&#34;</span>: <span style=color:#e6db74>&#34;Grace&#34;</span>,     <span style=color:#f92672>&#34;last&#34;</span>: <span style=color:#e6db74>&#34;Hopper&#34;</span>,   <span style=color:#f92672>&#34;year&#34;</span>: <span style=color:#ae81ff>1906</span> },
</span></span><span style=display:flex><span>    { <span style=color:#f92672>&#34;first&#34;</span>: <span style=color:#e6db74>&#34;Ada&#34;</span>,       <span style=color:#f92672>&#34;last&#34;</span>: <span style=color:#e6db74>&#34;Lovelace&#34;</span>, <span style=color:#f92672>&#34;year&#34;</span>: <span style=color:#ae81ff>1815</span> },
</span></span><span style=display:flex><span>    { <span style=color:#f92672>&#34;first&#34;</span>: <span style=color:#e6db74>&#34;Margaret&#34;</span>,  <span style=color:#f92672>&#34;last&#34;</span>: <span style=color:#e6db74>&#34;Hamilton&#34;</span>, <span style=color:#f92672>&#34;year&#34;</span>: <span style=color:#ae81ff>1936</span> }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><h3 id=4-加到一起>4) 加到一起</h3><p>剩下的就是加载 JSON 数据，调用 <code>JSContext</code> 将数据解析成 <code>Person</code> 对象的数组，并用 Mustache 模板呈现每个 <code>Person</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// get JSON string</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> peopleJSON = NSString(contentsOfFile:..., encoding: NSUTF8StringEncoding, error: <span style=color:#66d9ef>nil</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// get load function</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> load = context.objectForKeyedSubscript(<span style=color:#e6db74>&#34;loadPeopleFromJSON&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// call with JSON and convert to an array of `Person`</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> people = load.callWithArguments([peopleJSON]).toArray() <span style=color:#66d9ef>as</span>? [Person] {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// get rendering function and create template</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> mustacheRender = context.objectForKeyedSubscript(<span style=color:#e6db74>&#34;Mustache&#34;</span>).objectForKeyedSubscript(<span style=color:#e6db74>&#34;render&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> template = <span style=color:#e6db74>&#34;fullName, born birthYear&#34;</span>
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>        <span style=color:#75715e>// loop through people and render Person object as string</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> person <span style=color:#66d9ef>in</span> people {
</span></span><span style=display:flex><span>            println(mustacheRender.callWithArguments([template, person]))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Output:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Grace Hopper, born 1906</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Ada Lovelace, born 1815</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Margaret Hamilton, born 1936</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#75715e>// get JSON string
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>NSString <span style=color:#f92672>*</span>peopleJSON <span style=color:#f92672>=</span> [NSString stringWithContentsOfFile:... encoding:NSUTF8StringEncoding error:nil];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e>// get load function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>JSValue <span style=color:#f92672>*</span>load <span style=color:#f92672>=</span> context[<span style=color:#e6db74>@&#34;loadPeopleFromJSON&#34;</span>];
</span></span><span style=display:flex><span><span style=color:#75715e>// call with JSON and convert to an NSArray
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>JSValue <span style=color:#f92672>*</span>loadResult <span style=color:#f92672>=</span> [load callWithArguments:<span style=color:#ae81ff>@[</span>peopleJSON<span style=color:#ae81ff>]</span>];
</span></span><span style=display:flex><span>NSArray <span style=color:#f92672>*</span>people <span style=color:#f92672>=</span> [loadResult toArray];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e>// get rendering function and create template
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>JSValue <span style=color:#f92672>*</span>mustacheRender <span style=color:#f92672>=</span> context[<span style=color:#e6db74>@&#34;Mustache&#34;</span>][<span style=color:#e6db74>@&#34;render&#34;</span>];
</span></span><span style=display:flex><span>NSString <span style=color:#f92672>*</span>template <span style=color:#f92672>=</span> <span style=color:#e6db74>@&#34;ullName, born birthYear&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// loop through people and render Person object as string
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>for</span> (Person <span style=color:#f92672>*</span>person <span style=color:#66d9ef>in</span> people) {
</span></span><span style=display:flex><span>   NSLog(<span style=color:#e6db74>@&#34;%@&#34;</span>, [mustacheRender callWithArguments:<span style=color:#ae81ff>@[</span>template, person<span style=color:#ae81ff>]</span>]);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Output:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Grace Hopper, born 1906
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Ada Lovelace, born 1815
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Margaret Hamilton, born 1936
</span></span></span></code></pre></div><hr><p>在你的应用程序如何使用 JavaScript？JavaScript 代码段可能是附带应用一起发布的基本的用户定义的插件。如果你的产品开始在 web 上发布，你可能将现有的代码稍加改动即可适应需求。或者，如果<em>你</em>开始成为一个 web 程序员，你可能会享受追溯脚本根源的机会。无论是哪种情况，JavaScriptCore 都是精心打造和强大的，不容忽视。</p><hr><p>除非<a href=https://nshipster.cn/ target=_blank>另有声明</a>，本文采用知识共享「<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>署名-非商业性使用 3.0 中国大陆</a>」许可协议授权。</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top · 回顶部" rel=nofollow>&#127772;2015-01-19 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2025 Nate Cook 版权所有</a><a href=https://autoptr.top/ title="Back to Home · 回首页">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>标签:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>分类:</span><li><a class=link href=https://autoptr.top/categories/Cocoa target=_blank>Cocoa</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>