<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>Swift 1.2</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="Swift 1.2,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="Swift 1.2,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"🌜"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>Swift 1.2</span><span class=btRight><span title="Author · 作者" class=author>Nate Cook</span> <span title="Translator · 翻译" class=author>Croath Liu</span> <a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post · 关联或转载引用的文章" target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics · 回主题页">&#127793;</a></span></h1><p>Swift 正如其名，速度飞快。本周将关注 Swift 1.2 版本的一个 <em>重大</em> 更新。Swift 开发团队在这次加速俯冲中一次性响应了开发社区的诸多需求，带来了许多激动人心的新特性。本次发布的每一个小更新都带来了巨大的好处：增量构建、丰富了 Xcode 中的错误信息、提升 Xcode 稳定性、静态类属性、支持 C 的 union 和 bitfield、将 Swift 中的 <code>enum</code> 打通到 Objective-C 中、更安全的类型转换、单行闭包的提升等等。</p><p>在这么多的更新中我们主要关注两个明显提升使用体验的新功能：一个是 <code>if let</code> 语句 optional 绑定 <em>终于有了</em> 巨大变化，另一个是 Objective-C 中的空值标注。</p><h2 id=提升-optional-绑定>提升 Optional 绑定</h2><p>Swift 1.2 允许通过多值并行 optional 绑定来避免 <code>if let</code> 语句的多重深嵌套。多个 optional 绑定可以通过逗号分隔开，并且可以带一个和传统的 <code>if</code> 语句同样效果的 <code>where</code> 分句。这样的话，拜占庭的 <a href=http://www.scottlogic.com/blog/2014/12/08/swift-optional-pyramids-of-doom.html>厄运金字塔</a> 就可以被修缮成中世纪风格的现代牧场了：</p><p><strong>从前：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> a = <span style=color:#e6db74>&#34;10&#34;</span>.toInt()
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> b = <span style=color:#e6db74>&#34;5&#34;</span>.toInt()
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> c = <span style=color:#e6db74>&#34;3&#34;</span>.toInt()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> a = a {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> b = b {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> c = c {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> c <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>                println(<span style=color:#e6db74>&#34;(a + b) / c = </span><span style=color:#e6db74>\((</span>a <span style=color:#f92672>+</span> b<span style=color:#e6db74>)</span> <span style=color:#f92672>/</span> c<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>现在：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> a = a, b = b, c = c <span style=color:#66d9ef>where</span> c <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>    println(<span style=color:#e6db74>&#34;(a + b) / c = </span><span style=color:#e6db74>\((</span>a <span style=color:#f92672>+</span> b<span style=color:#e6db74>)</span> <span style=color:#f92672>/</span> c<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>)     <span style=color:#75715e>// (a + b) / c = 5</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>这两个例子中判断语句的执行顺序是一样的。使用新的语法可以让每个绑定都按顺序执行，如果某一个绑定是 <code>nil</code> 就会停下来。只有在所有的 optional binding 都成功的情况下才会进行 <code>where</code> 语句检查。</p><p>一个 <code>if</code> 语句可以包含多个通过逗号分隔的 <code>let</code> 绑定。因为每个 <code>let</code> 可以绑定多个 optional <em>和</em> 一个 <code>where</code> 分句，所以通过这种方式可以支持真正更高级的逻辑。（感谢 <a href=https://twitter.com/stephencelis>Stephen Celis</a> 帮忙解释清楚这点。）</p></blockquote><p>更棒的是，后续的绑定语句可以引用之前的绑定。这意味着你只用一个 <code>if let</code> 语句就可以解析 <code>Dictionary</code> 对象或者对 <code>AnyObject?</code> 值进行强制类型转换，然后将其用于另一个语句中。</p><p>让我们回顾一个经典的例子，将 <a href=http://jsonplaceholder.typicode.com/users>这样一个庞大的 JSON 块</a> 在 Swift 1.2 中解析。样例中用一个 <code>if let</code> 将 JSON 解析成指定的包含 <code>NSBundle</code>、<code>NSURL</code> 和 <code>NSData</code> 类型以及一些 <code>AnyObject?</code> 值的对象：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>var</span> users: [User] = []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// load and parse the JSON into an array</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>    path     = NSBundle.mainBundle().pathForResource(<span style=color:#e6db74>&#34;users&#34;</span>, ofType: <span style=color:#e6db74>&#34;json&#34;</span>),
</span></span><span style=display:flex><span>    url      = NSURL(fileURLWithPath: path),
</span></span><span style=display:flex><span>    data     = NSData(contentsOfURL: url),
</span></span><span style=display:flex><span>    userList = NSJSONSerialization.JSONObjectWithData(data, options: <span style=color:#66d9ef>nil</span>, error: <span style=color:#66d9ef>nil</span>) <span style=color:#66d9ef>as</span>? [[String: AnyObject]] 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// extract individual users</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> userDict <span style=color:#66d9ef>in</span> userList {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>            id      = userDict[<span style=color:#e6db74>&#34;id&#34;</span>] <span style=color:#66d9ef>as</span>? Int,
</span></span><span style=display:flex><span>            name    = userDict[<span style=color:#e6db74>&#34;name&#34;</span>] <span style=color:#66d9ef>as</span>? String,
</span></span><span style=display:flex><span>            email   = userDict[<span style=color:#e6db74>&#34;email&#34;</span>] <span style=color:#66d9ef>as</span>? String,
</span></span><span style=display:flex><span>            address = userDict[<span style=color:#e6db74>&#34;address&#34;</span>] <span style=color:#66d9ef>as</span>? [String: AnyObject]
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            users.append(User(id: id, name: name, ...))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Leanne Graham&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;Bret&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;Sincere@april.biz&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;address&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;street&#34;</span>: <span style=color:#e6db74>&#34;Kulas Light&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;suite&#34;</span>: <span style=color:#e6db74>&#34;Apt. 556&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;city&#34;</span>: <span style=color:#e6db74>&#34;Gwenborough&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;zipcode&#34;</span>: <span style=color:#e6db74>&#34;92998-3874&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;geo&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;lat&#34;</span>: <span style=color:#e6db74>&#34;-37.3159&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;lng&#34;</span>: <span style=color:#e6db74>&#34;81.1496&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;phone&#34;</span>: <span style=color:#e6db74>&#34;1-770-736-8031 x56442&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;website&#34;</span>: <span style=color:#e6db74>&#34;hildegard.org&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;company&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Romaguera-Crona&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;catchPhrase&#34;</span>: <span style=color:#e6db74>&#34;Multi-layered client-server neural-net&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;bs&#34;</span>: <span style=color:#e6db74>&#34;harness real-time e-markets&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Ervin Howell&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;Antonette&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;Shanna@melissa.tv&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;address&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;street&#34;</span>: <span style=color:#e6db74>&#34;Victor Plains&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;suite&#34;</span>: <span style=color:#e6db74>&#34;Suite 879&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;city&#34;</span>: <span style=color:#e6db74>&#34;Wisokyburgh&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;zipcode&#34;</span>: <span style=color:#e6db74>&#34;90566-7771&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;geo&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;lat&#34;</span>: <span style=color:#e6db74>&#34;-43.9509&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;lng&#34;</span>: <span style=color:#e6db74>&#34;-34.4618&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;phone&#34;</span>: <span style=color:#e6db74>&#34;010-692-6593 x09125&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;website&#34;</span>: <span style=color:#e6db74>&#34;anastasia.net&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;company&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Deckow-Crist&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;catchPhrase&#34;</span>: <span style=color:#e6db74>&#34;Proactive didactic contingency&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;bs&#34;</span>: <span style=color:#e6db74>&#34;synergize scalable supply-chains&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>我感觉我们之后写的代码中会有不少的逗号出现。</p><h2 id=空值标注>空值标注</h2><p>在 Swift 第一版发布的时候，每一个对 Cocoa API 的调用方法都会返回一个模糊解析的 optional 类型（比如说 <code>AnyObject!</code>）。因为它们会在读取过程中让程序崩溃，所以如果没有清晰的文档表明该方法是否会返回一个 null 值那么这种模糊解析内在是不安全的。这些都是不好的现象。Swift 确实能够调用 Cocoa API 了，但调用方法长得真奇怪。</p><p>随着 beta 发布的完善，内部评估中不断移除不友好的标点符号，用真 optional 、非 optional 或永不为空的值来替代模糊解析的 optional。这极大提高了使用 Cocoa 时的体验，但是，使用三方代码的时候这个问题却仍然存在。</p><p>这种情况不复存在了！Swift 1.2 带来了新版本的 Clang。新的属性参数和指针标注允许指针、Objective-C 属性、方法参数或返回值是否可以为 <code>nil</code>。</p><blockquote><ul><li><code>nonnull</code>：标示该指针 <code>不应该</code> 为 <code>nil</code>。在 Swift 中使用标注 <code>nonnull</code> 的指针时会保留他们原始的值（例如 <code>NSData</code>）。</li><li><code>nullable</code>：标示该指针在通常情况下 <code>可以</code> 为 <code>nil</code>。它们在 Swift 中会以 optional 值表示（比如 <code>NSURL?</code>）。</li><li><code>null_unspecified</code>：像以前一样的模糊解析 optional 类型，理想状态是只标注而不使用。</li><li><code>null_resettable</code>：标示这个属性永远会有一个值，也可以被赋为 <code>nil</code>。拥有非 <code>nil</code> 默认值的属性可以用这个字段标注，例如：<code>tintColor</code>。根据文档，这种属性在 Swift 中使用时会变成一种（相对安全）的模糊解析 optional 类型。</li></ul></blockquote><p>前三种标注也可以通过双下划线前置（<code>__nonnull</code>、<code>__nullable</code> 和 <code>__null_unspecified</code>）用于 C 指针和 block 指针。最后一种 <code>null_resettable</code> 标注仅可用于 Objective-C 属性。</p><h3 id=立即动手尝试>立即动手尝试</h3><p>下面的样例中，我们使用一个 data controller 来控制一个位置信息列表，每个位置信息可能附图。这个样例展示了这几种新标注的优点：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>LocationDataController</span> : <span style=color:#a6e22e>NSObject</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>readonly</span>) NSArray <span style=color:#f92672>*</span>locations;
</span></span><span style=display:flex><span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>readonly</span>) Location <span style=color:#f92672>*</span>latestLocation;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>addPhoto:</span>(Photo <span style=color:#f92672>*</span>)photo <span style=color:#a6e22e>forLocation:</span>(Location <span style=color:#f92672>*</span>)location;
</span></span><span style=display:flex><span>- (Photo <span style=color:#f92672>*</span>)<span style=color:#a6e22e>photoForLocation:</span>(Location <span style=color:#f92672>*</span>)location;
</span></span><span style=display:flex><span><span style=color:#66d9ef>@end</span>
</span></span></code></pre></div><p>如果不用空值标注，<code>LocationDataController</code> 类中的每个指针在 Swift 中使用时都会变成模糊解析的 optional 类型：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LocationDataController</span> : NSObject {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> locations: [AnyObject]<span style=color:#f92672>!</span> { <span style=color:#66d9ef>get</span> }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> latestLocation: Location! { <span style=color:#66d9ef>get</span> }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>addPhoto</span>(photo: Photo!, forLocation location: Location!)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>photoForLocation</span>(location: Location!) -&gt; Photo!
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这！么！多！感！叹！号！真！是！够！了！如果在 Objective-C 中就标注好：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>LocationDataController</span> : <span style=color:#a6e22e>NSObject</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@property</span> (nonnull, <span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>readonly</span>) NSArray <span style=color:#f92672>*</span>locations;
</span></span><span style=display:flex><span><span style=color:#66d9ef>@property</span> (nullable, <span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>readonly</span>) Location <span style=color:#f92672>*</span>latestLocation;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>addPhoto:</span>(nonnull Photo <span style=color:#f92672>*</span>)photo <span style=color:#a6e22e>forLocation:</span>(nonnull Location <span style=color:#f92672>*</span>)location;
</span></span><span style=display:flex><span>- (nullable Photo <span style=color:#f92672>*</span>)<span style=color:#a6e22e>photoForLocation:</span>(nonnull Location <span style=color:#f92672>*</span>)location;
</span></span><span style=display:flex><span><span style=color:#66d9ef>@end</span>
</span></span></code></pre></div><p>首先 <code>locations</code> 列表是 <code>nonnull</code> 的，因为最糟糕的情况下它也就是一个空数组了，但如果列表中没有任何位置信息，<code>latestLocation</code> 却 <em>可以</em> 是 <code>nil</code>。同理，两个方法中的参数永远不应该为空。因为不是每个位置信息都有一张照片，所以第二个方法的返回值是 <code>nullable</code> 型的 Photo 实例。这种声明方式在 Swift 中就变得更好、更清晰、更安全，而且也没那么多烦人的感叹号了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LocationDataController</span> : NSObject {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> locations: [AnyObject] { <span style=color:#66d9ef>get</span> }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> latestLocation: Location? { <span style=color:#66d9ef>get</span> }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>addPhoto</span>(photo: Photo, forLocation location: Location)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>photoForLocation</span>(location: Location) -&gt; Photo?
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ns_assume_nonnull_beginend>NS_ASSUME_NONNULL_BEGIN/END</h3><p>在 Objective-C 头文件中标注 <em>任何</em> 指针都会导致编译器对整个文件进行标注分析，带来不少的警告。因为大多数的标注都是 <code>nonnull</code> 的，一个用于标注已存在类的提高效率的宏就出现了。在头文件中，例外情况单独标注，其他地方开始和结尾的地方用 <code>NS_ASSUME_NONNULL_BEGIN</code> 和 <code>..._END</code> 包围起来就好了。</p><p>和上述 data controller 能在 Swift 中产生同样效果的另一个更易读的版本就出现了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>LocationDataController</span> : <span style=color:#a6e22e>NSObject</span>
</span></span><span style=display:flex><span>NS_ASSUME_NONNULL_BEGIN
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>readonly</span>) NSArray <span style=color:#f92672>*</span>locations;
</span></span><span style=display:flex><span><span style=color:#66d9ef>@property</span> (nullable, <span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>readonly</span>) Location <span style=color:#f92672>*</span>latestLocation;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>addPhoto:</span>(Photo <span style=color:#f92672>*</span>)photo <span style=color:#a6e22e>forLocation:</span>(Location <span style=color:#f92672>*</span>)location;
</span></span><span style=display:flex><span>- (nullable Photo <span style=color:#f92672>*</span>)<span style=color:#a6e22e>photoForLocation:</span>(Location <span style=color:#f92672>*</span>)location;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NS_ASSUME_NONNULL_END
</span></span><span style=display:flex><span><span style=color:#66d9ef>@end</span>
</span></span></code></pre></div><h3 id=不只是-swift>不只是 Swift</h3><p>新的 Objective-C 空值标注为 Swift 带来了巨大好处，与此同时如果不写任何 Swift 还是可以从中受益的。如果将 <code>nil</code> 值传给了带有 <code>nonnull</code> 标注的指针，那么自动补全时就会有提示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#75715e>// Can I remove a photo by sending nil?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>[dataController addPhoto:nil forLocation:currentLocation];
</span></span><span style=display:flex><span><span style=color:#75715e>// Nope -- Warning: Null passed to a callee that requires a non-null argument
</span></span></span></code></pre></div><hr><p>激动人心的是，关于这次更新的故事我们只讲了一半。除了 Swift 语法的变化和编译器变异方式的变化之外，标准库也升级到了一个 <a href=http://swiftdoc.org/news/2015/02/swift1.2/>大版本</a>，带来了新的 <code>Set</code> 类（再见了<a href=https://github.com/natecook1000/SwiftSets/blob/master/Set.swift>朋友</a>）。<em>呵呵呵呵</em>，所以，我们以前的代码也都不能运行了，Stack Overflow 上又多了 21,000 个过期的 Swift 问题？其实想想还蛮有意思的。</p><script language=Javascript>$(document).ready(function(){$("code.language-objective-c .n").each(function(e,t){var n=$(t).text();(n=="nullable"||n=="nonnull")&&$(t).css("font-weight","bold")})})</script><hr><p>除非<a href=https://nshipster.cn/ target=_blank>另有声明</a>，本文采用知识共享「<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>署名-非商业性使用 3.0 中国大陆</a>」许可协议授权。</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top · 回顶部" rel=nofollow>&#127772;2015-02-09 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2025 Nate Cook 版权所有</a><a href=https://autoptr.top/ title="Back to Home · 回首页">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>标签:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>分类:</span><li><a class=link href=https://autoptr.top/categories/Swift target=_blank>Swift</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>