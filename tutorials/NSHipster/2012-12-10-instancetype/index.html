<!doctype html><html><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=.5"><title>instancetype</title>
<link rel="shortcut icon" type=image/x-icon href=/media/shortcuticon.png><meta name=keywords content="instancetype,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><meta name=description content="instancetype,macOS,C++,Cocoa,Objective-C,Swift,NSHipster"><script>if(document.domain=="autoptr.pages.dev"){var url=window.location.href,url=url.replace(/autoptr+\.pages+\.dev/g,"www.autoptr.top");window.location.href=url}</script><script src=/jscss/ajax/libs/anchor-js/4.2.0/anchor.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){anchors.options={visible:"hover",placement:"left",icon:"🌜"},anchors.add()})</script><link rel=stylesheet href=/css/main.css><link href=/jscss/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css rel=stylesheet><script src=/jscss/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><style type=text/css>body{background-color:#fbf6ec}</style><script>top.location!=self.location&&(top.location=self.location)</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?746e6e6d14d22526bf274c834750df53",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><script>window.addEventListener("resize",resizeThrottler,!1);var resizeTimeout;function resizeThrottler(){resizeTimeout||(resizeTimeout=setTimeout(function(){resizeTimeout=null,actualResizeHandler()},66))}actualResizeHandler();function actualResizeHandler(){/mobile/i.test(navigator.userAgent)||/android/i.test(navigator.userAgent)?document.body.classList.add("mobile"):document.body.classList.remove("mobile")}</script><a id=mysite-singlepage-top></a><div class=inner style=position:relative><div class=blog-post><h1 class=blog-title align=center><span class=btContent>instancetype</span><span class=btRight><span title="Author · 作者" class=author>Mattt</span> <span title="Translator · 翻译" class=author>JJ Mao</span> <a href=https://github.com/NSHipster/articles-zh-Hans style=color:#007cd5 title="Related or Quoted Post · 关联或转载引用的文章" target=_blank rel="nofollow noopener noreferrer">&#128681;</a><a href=/tutorials/NSHipster/ title="Back to Topics · 回主题页">&#127793;</a></span></h1><p>想知道Objective-C接下去会发生什么吗？<a href=http://clang.llvm.org/docs/LanguageExtensions.html>请多关注Objective-C最新动向</a>。</p><p>Objective-C 是一门正迅速发展的语言，这种发展速度在别的现有语言中是不曾有过的。ARC，object literals，subscripting，blocks：在短短的三年时间里，Objective-C编程的许多方式发生了改变（变得更好）。</p><p>这一切的创新都是Apple垂直整合的成果。正如Apple在设计<a href=https://en.wikipedia.org/wiki/Apple_A4>自主研发芯片</a>中的投资一样，利用杠杆作用与手机硬件展开激烈的竞争。在<a href=http://llvm.org>LLVM</a> 上的投资也是一样，使软件跟上业界最新步伐。</p><p>Clang从普通到范例转变的发展，真要说清它们之间的差异还得慢慢来。因为我们正在讨论的是底层语言的特性，对于API设计的更深层含义还比较难理解。</p><p>其中一个例子就是 <code>instancetype</code> ，这也是本周文章的主题。</p><hr><p>Objective-C的一些使用惯例不仅仅是好的编程习惯，更是给编译器的隐藏指令。</p><p>例如， <code>alloc</code> 和 <code>init</code> 的返回类型都是 <code>id</code> ，然而在Xcode中，编译器会检查所有正确类型。它是怎么做到的呢？</p><p>在Cocoa中，约定 <code>alloc</code> 或 <code>init</code> 的方法总是返回接收器类实例的对象。据说这些方法有一个<strong>相关返回类型</strong>。</p><p>虽然类构造方法也是返回 <code>id</code> ，但是类构造方法并没有做同样的类型检查，因为它们不遵循命名规范。</p><p>你可以自己试着这样：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>[[[NSArray alloc] init] mediaPlaybackAllowsAirPlay]; <span style=color:#75715e>// ❗ &#34;No visible @interface for `NSArray` declares the selector `mediaPlaybackAllowsAirPlay`&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>[[NSArray array] mediaPlaybackAllowsAirPlay]; <span style=color:#75715e>// (No error)
</span></span></span></code></pre></div><p>由于 <code>alloc</code> 和 <code>init</code> 作为相关返回类型遵循命名规范，执行对 <code>NSArray</code> 的正确类型检查。然而，等价类构造函数 <code>array</code> 不遵循命名规范，它被认为是 <code>id</code> 类型。</p><p><code>id</code> 类型对于禁用类型安全性检查非常有用，但当你 <em>确实</em> 需要它的时候却没有时，情况会变得非常糟糕。</p><p>另一种显示声明返回类型（在之前例子中的 <code>(NSArray *)</code>）的方式有了稍微的改进，但是它不利于子类的发挥。</p><p>所以编译器从这里介入以解决Objective-C类型系统的这个永恒边界情况：</p><p><code>instancetype</code> 关键字，它可以表示一个方法的相关返回类型。例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span><span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>Person</span>
</span></span><span style=display:flex><span>+ (<span style=color:#66d9ef>instancetype</span>)<span style=color:#a6e22e>personWithName:</span>(NSString <span style=color:#f92672>*</span>)name;
</span></span><span style=display:flex><span><span style=color:#66d9ef>@end</span>
</span></span></code></pre></div><blockquote><p><code>instancetype</code> 与 <code>id</code> 不一样, <code>instancetype</code> 只能在方法声明中作为返回类型使用。</p></blockquote><p>使用 <code>instancetype</code> ，编译器将正确的推断出 <code>+personWithName:</code> 是 <code>Person</code> 的一个实例。</p><p>为了在不久的将来使用 <code>instancetype</code> ，你可以在Foundation中查找类构造函数。例如<a href=https://developer.apple.com/library/ios/#documentation/uikit/reference/UICollectionViewLayoutAttributes_class/Reference/Reference.html>UICollectionViewLayoutAttributes</a> 就已经正在使用 <code>instancetype</code> 了。</p><h2 id=深层含义>深层含义</h2><p>语言特性十分有趣，因为它在高级软件设计方面的的影响往往是模糊的。</p><p>然而 <code>instancetype</code> 看似普通，尽管它能为编译器锦上添花，但它可用于更棒的结果。</p><p><a href=https://twitter.com/jonsterling>Jonathan Sterling</a> 写了<a href=http://www.jonmsterling.com/posts/2012-02-05-typed-collections-with-self-types-in-objective-c.html>这篇十分有趣的文章</a>, 文章中详细描述了 <code>instancetype</code> 在没有<a href=https://en.wikipedia.org/wiki/Generic_programming>泛型</a>的情况下是如何用于静态类型collections编码的:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=display:flex><span>NSURL <span style=color:#f92672>&lt;</span>MapCollection<span style=color:#f92672>&gt;</span> <span style=color:#f92672>*</span>sites <span style=color:#f92672>=</span> (<span style=color:#66d9ef>id</span>)[NSURL mapCollection];
</span></span><span style=display:flex><span>[sites put:[NSURL URLWithString:<span style=color:#e6db74>@&#34;http://www.jonmsterling.com/&#34;</span>]
</span></span><span style=display:flex><span>        at:<span style=color:#e6db74>@&#34;jon&#34;</span>];
</span></span><span style=display:flex><span>[sites put:[NSURL URLWithString:<span style=color:#e6db74>@&#34;http://www.nshipster.com/&#34;</span>]
</span></span><span style=display:flex><span>        at:<span style=color:#e6db74>@&#34;nshipster&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NSURL <span style=color:#f92672>*</span>jonsSite <span style=color:#f92672>=</span> [sites at:<span style=color:#e6db74>@&#34;jon&#34;</span>]; <span style=color:#75715e>// =&gt; http://www.jonmsterling.com/
</span></span></span></code></pre></div><p>静态类型collections会使APIs更富有表现力&ndash;开发者可以确定一个collection参数中允许使用的对象类型。</p><p>不论这是否能在Objective-C中成为公认的规范，更令人着迷的是像 <code>instancetype</code> 这样的底层特性是如何用于改变语言轮廓的(在这种情况下，使其看似更像<a href=https://en.wikipedia.org/wiki/C_Sharp_(programming_language)>C#</a>）。</p><hr><p><code>instancetype</code> 只是众多语言之中的一种对Objective-C的扩展，使它更多的被添加到每个新版本中。</p><p>认识它并爱上它。</p><p>以此作为如何关注底层细节的例子，将给你带来全新的视角以强有力的方式去改变Objective-C。</p><hr><p>除非<a href=https://nshipster.cn/ target=_blank>另有声明</a>，本文采用知识共享「<a href=https://creativecommons.org/licenses/by-nc/3.0/cn/ target=_blank>署名-非商业性使用 3.0 中国大陆</a>」许可协议授权。</p><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8922574795542092 data-ad-slot=2802455178 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer><p style="margin:0 -3px"><span style="float:left;margin:0 -3px"><a href=#mysite-singlepage-top title="Back to Top · 回顶部" rel=nofollow>&#127772;2012-12-10 </a>&copy;</span>
<span style="float:right;margin:0 -3px"><a href=https://autoptr.top/license/ title="Copyright &copy; All rights reserved" target=_blank rel=nofollow>&copy; 2025 Mattt 版权所有</a><a href=https://autoptr.top/ title="Back to Home · 回首页">&#127771;</a></span></p><hr><hr><p style="margin:3px 5px"><ul class=tags><span>标签:</span><li><a class=link href=https://autoptr.top/tags/C++ target=_blank>C++</a></li><li><a class=link href=https://autoptr.top/tags/nshipster target=_blank>nshipster</a></li><span>&nbsp;&nbsp;</span>
<span>分类:</span><li><a class=link href=https://autoptr.top/categories/Objective-C target=_blank>Objective-C</a></li><li><a class=link href=https://autoptr.top/categories/macOS target=_blank>macOS</a></li><li><a class=link href=https://autoptr.top/categories/CC++ target=_blank>CC++</a></li></ul><p style=margin-bottom:2em></p></p></footer></div><script src=/jscss/ajax/libs/jquery/3.3.1/jquery.slim.min.js></script><script src=/jscss/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-37ZP0S1L3D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-37ZP0S1L3D")</script><script src=/jscss/ajax/libs/medium-zoom/1.0.4/medium-zoom.min.js></script><script>const zoom=mediumZoom();zoom.attach("p img")</script></body></html>